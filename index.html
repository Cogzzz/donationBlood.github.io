<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>PMI Blood Heroes - Blood Donation Educational Game</title>
  <!-- Tailwind CSS CDN -->
  <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" />
  <!-- Slick Slider -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/slick-carousel/1.8.1/slick.min.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/slick-carousel/1.8.1/slick-theme.min.css" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/slick-carousel/1.8.1/slick.min.js"></script>
  <style>
    html {
      scroll-behavior: smooth;
    }

    .hero-slider .slick-slide {
      height: 500px;
    }

    .hero-slider .slick-dots {
      bottom: 25px;
    }

    .hero-slider .slick-dots li button:before {
      color: white;
      font-size: 12px;
      opacity: 0.7;
    }

    .hero-slider .slick-dots li.slick-active button:before {
      color: white;
      opacity: 1;
    }

    .hero-slider .slick-arrow {
      z-index: 10;
    }

    .hero-slider .slick-prev {
      left: 20px;
    }

    .hero-slider .slick-next {
      right: 20px;
    }

    .hero-slider .slick-prev:before,
    .hero-slider .slick-next:before {
      font-size: 24px;
    }

    .slide-badge {
      display: inline-block;
      background-color: rgba(220, 38, 38, 0.9);
      padding: 4px 12px;
      border-radius: 9999px;
      font-size: 0.875rem;
      font-weight: 600;
      margin-bottom: 1rem;
    }

    .card-animate {
      opacity: 0;
      animation: fadeIn 0.8s ease-in forwards;
    }

    .card-animate:nth-child(1) {
      animation-delay: 100ms;
    }

    .card-animate:nth-child(2) {
      animation-delay: 300ms;
    }

    .card-animate:nth-child(3) {
      animation-delay: 500ms;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(10px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    /* Responsive design for navigation */
    @media (max-width: 768px) {
      .desktop-nav {
        display: none;
      }
    }

    @media (min-width: 769px) {
      .mobile-nav {
        display: none;
      }
    }

    #simulation {
      max-width: 800px;
      margin: 0 auto;
      padding: 20px;
      background-color: white;
      border-radius: 8px;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
    }

    .scene {
      width: 100%;
      height: 450px;
      background-color: #fff;
      border-radius: 10px;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
      margin-bottom: 20px;
      position: relative;
      overflow: hidden;
    }

    .scene-content {
      width: 100%;
      height: 100%;
      position: relative;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
    }

    .controls {
      background-color: #f8f8f8;
      padding: 10px;
      border-radius: 10px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      display: flex;
      justify-content: center;
      flex-wrap: wrap;
      gap: 5px;
    }

    .item {
      width: 60px;
      height: 60px;
      cursor: pointer;
      display: inline-block;
      margin: 5px;
      border: 2px solid transparent;
      border-radius: 5px;
      padding: 5px;
      transition: all 0.3s;
    }

    .item:hover {
      border-color: #d32f2f;
      background-color: #ffebee;
    }

    .selected {
      border-color: #d32f2f;
      box-shadow: 0 0 5px #d32f2f;
      background-color: #ffebee;
    }

    .patient {
      position: relative;
    }

    .vein {
      stroke: #5c6bc0;
      stroke-width: 3;
      stroke-opacity: 0.7;
    }

    .blood-sample {
      position: absolute;
      display: none;
    }

    .test-result {
      width: 120px;
      height: 60px;
      background-color: #fff;
      border: 1px solid #ccc;
      position: absolute;
      top: 50px;
      right: 50px;
      font-size: 14px;
      padding: 5px;
      text-align: center;
      display: none;
      border-radius: 5px;
    }

    .patient-target {
      position: relative;
      height: 350px;
      width: 200px;
      display: none;
    }

    .blood-bag {
      position: absolute;
      display: none;
      cursor: grab;
    }

    .progress-container {
      width: 100%;
      background-color: #e0e0e0;
      border-radius: 5px;
      margin-top: 20px;
    }

    .progress-bar {
      width: 0;
      height: 20px;
      background-color: #d32f2f;
      border-radius: 5px;
      text-align: center;
      line-height: 20px;
      color: white;
    }

    .message {
      background-color: #fff;
      padding: 10px;
      margin-top: 10px;
      border-radius: 5px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      font-weight: bold;
      text-align: center;
    }

    .btn {
      background-color: #d32f2f;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 5px;
      cursor: pointer;
      margin-top: 10px;
      font-weight: bold;
      transition: background-color 0.3s;
    }

    .btn:hover {
      background-color: #b71c1c;
    }

    .btn:disabled {
      background-color: #e0e0e0;
      cursor: not-allowed;
    }

    .fade-in {
      animation: fadeIn 0.5s;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
      }

      to {
        opacity: 1;
      }
    }

    .fade-out {
      animation: fadeOut 0.5s;
    }

    @keyframes fadeOut {
      from {
        opacity: 1;
      }

      to {
        opacity: 0;
      }
    }

    .transition-overlay {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.8);
      display: flex;
      align-items: center;
      justify-content: center;
      flex-direction: column;
      color: white;
      font-size: 24px;
      text-align: center;
      z-index: 100;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.5s;
    }

    .transition-overlay.active {
      opacity: 1;
      pointer-events: all;
    }

    .stage-title {
      font-size: 32px;
      margin-bottom: 20px;
      color: #ff5252;
    }

    .stage-desc {
      font-size: 18px;
      max-width: 80%;
      line-height: 1.5;
    }

    .laboratory {
      background-color: #f5f5f5;
      width: 100%;
      height: 100%;
      display: none;
      position: relative;
      background-image: linear-gradient(to bottom, #f5f5f5, #e0e0e0);
    }

    .lab-table {
      width: 80%;
      height: 200px;
      background-color: #e0e0e0;
      position: absolute;
      bottom: 50px;
      left: 10%;
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
      border: 1px solid #bdbdbd;
    }

    .transfusion-room {
      background-color: #e8f5e9;
      width: 100%;
      height: 100%;
      display: none;
      position: relative;
      background-image: linear-gradient(to bottom, #e8f5e9, #c8e6c9);
    }

    .transfusion-stand {
      transition: filter 0.3s ease;
    }

    .alert {
      padding: 15px;
      color: white;
      background-color: #4CAF50;
      border-radius: 5px;
      position: fixed;
      top: 20px;
      left: 50%;
      transform: translateX(-50%);
      z-index: 1000;
      display: none;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
    }

    svg {
      display: block;
    }

    .blood-flow {
      stroke-dasharray: 10, 5;
      animation: flow 5s linear infinite;
      z-index: 5;
    }

    @keyframes flow {
      from {
        stroke-dashoffset: 1000;
      }

      to {
        stroke-dashoffset: 0;
      }
    }

    @keyframes pulse {
      from {
        r: 5;
        fill: #e53935;
      }

      to {
        r: 7;
        fill: #c62828;
      }
    }

    .blood-drop-animation {
      position: absolute;
      width: 20px;
      height: 20px;
      background-color: #e53935;
      border-radius: 50% 50% 50% 0;
      transform: rotate(-45deg);
      animation: dropBlood 1s forwards;
    }

    @keyframes dropBlood {
      0% {
        transform: translate(-50%, -100%) rotate(-45deg);
        opacity: 1;
      }

      100% {
        transform: translate(-50%, 0) rotate(-45deg);
        opacity: 0;
      }
    }

    /* Tambahkan style untuk visualisasi yang lebih jelas pada penggumpalan */
    .coagulation-positive {
      animation: pulseCoagulation 1.5s infinite;
    }

    @keyframes pulseCoagulation {
      0% {
        fill-opacity: 0.5;
      }

      50% {
        fill-opacity: 0.9;
      }

      100% {
        fill-opacity: 0.5;
      }
    }

    /* Style untuk drop-zone yang lebih jelas */
    .drop-zone-highlight {
      stroke-dasharray: 5;
      animation: dash 2s linear infinite;
    }

    .drop-zone-active {
      fill: rgba(255, 235, 238, 0.7);
      stroke: #b71c1c;
      stroke-width: 4;
    }

    @keyframes dash {
      to {
        stroke-dashoffset: 20;
      }
    }

    @keyframes pulseBorder {
      0% {
        border-color: #ff1744;
      }

      50% {
        border-color: #ff616f;
      }

      100% {
        border-color: #ff1744;
      }
    }

    /* Highlight untuk transfusion stand */
    .stand-highlight {
      filter: drop-shadow(0 0 5px rgba(255, 23, 68, 0.7));
    }

    /* Additional styles for the simulation tabs */
    .sim-tabs {
      display: flex;
      margin-bottom: 1rem;
      border-bottom: 1px solid #e0e0e0;
    }

    .sim-tab {
      background-color: #f5f5f5;
      color: #333;
      padding: 10px 20px;
      border-radius: 5px 5px 0 0;
      border: 1px solid #e0e0e0;
      border-bottom: none;
      margin-right: 5px;
      cursor: pointer;
      transition: all 0.3s;
    }

    .sim-tab.active {
      background-color: #d32f2f;
      color: white;
      border-color: #b71c1c;
    }

    .sim-tab:hover:not(.active) {
      background-color: #eeeeee;
    }

    /* Responsive design */
    @media (max-width: 768px) {
      .scene {
        height: 350px;
      }

      .controls {
        flex-wrap: wrap;
      }

      .item {
        width: 50px;
        height: 50px;
      }
    }

    .blood-type-btn.selected,
    .rh-btn.selected {
      background-color: #fee2e2;
      border-color: #ef4444;
      border-width: 2px;
      box-shadow: 0 0 0 2px rgba(239, 68, 68, 0.3);
      transform: scale(1.05);
    }

    /* Animasi untuk penggumpalan darah */
    @keyframes coagulationPulse {
      0% {
        opacity: 0.6;
      }

      50% {
        opacity: 1;
      }

      100% {
        opacity: 0.6;
      }
    }

    .coagulation-positive {
      animation: coagulationPulse 2s infinite;
    }

    /* Efek flash saat jawaban salah */
    @keyframes flashError {
      0% {
        background-color: #fff;
      }

      50% {
        background-color: #fee2e2;
      }

      100% {
        background-color: #fff;
      }
    }

    .flash-error {
      animation: flashError 0.6s ease-in-out;
    }

    /* Efek muncul untuk interface pemilihan golongan darah */
    @keyframes fadeIn {
      0% {
        opacity: 0;
        transform: translateY(10px);
      }

      100% {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .fade-in {
      animation: fadeIn 0.5s ease-out forwards;
    }

    /* Efek sukses untuk hasil tes yang benar */
    @keyframes successPulse {
      0% {
        transform: scale(1);
      }

      50% {
        transform: scale(1.05);
      }

      100% {
        transform: scale(1);
      }
    }

    .success-pulse {
      animation: successPulse 1s ease-in-out;
    }

    /* Efek hover untuk tombol */
    .blood-type-btn:hover,
    .rh-btn:hover {
      background-color: #fee2e2;
      border-color: #ef4444;
      transform: translateY(-2px);
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
    }

    /* Styling tambahan untuk tampilan hasil tes */
    #test-result-display {
      transform-origin: center;
      transition: all 0.3s ease;
    }

    #test-result-display.show {
      opacity: 1;
      transform: scale(1);
    }

    /* Efek tetesan darah tambahan */
    .blood-drop {
      position: absolute;
      width: 10px;
      height: 15px;
      background-color: #ef4444;
      border-radius: 50% 50% 50% 50% / 60% 60% 40% 40%;
      animation: dropAnimation 1.5s forwards;
    }

    @keyframes dropAnimation {
      0% {
        transform: translateY(-20px);
        opacity: 0;
      }

      20% {
        opacity: 1;
      }

      100% {
        transform: translateY(100px);
        opacity: 0;
      }
    }

    /* Kotak bantuan dengan efek bayangan */
    .helper-box {
      border-left: 4px solid #3b82f6;
      background-color: #eff6ff;
      padding: 1rem;
      margin-bottom: 1rem;
      border-radius: 0.375rem;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
    }

    /* Efek hover pada tombol konfirmasi */
    #btn-confirm {
      transition: all 0.3s ease;
    }

    #btn-confirm:hover {
      box-shadow: 0 4px 6px rgba(239, 68, 68, 0.25);
    }

    .blood-run-game {
      background: linear-gradient(135deg, #e3f2fd 0%, #ffeaea 100%);
      width: 100%;
      height: 100%;
      display: none;
      /* Initially hidden */
      position: relative;
    }

    #blood-run-canvas {
      background-color: #fff;
      background-image: url('img/background.png');
      background-size: cover;
      background-repeat: repeat-x;
      animation: animatebackground 15s linear infinite;
      border: 3px solid #ff3434;
      border-radius: 15px;
      box-shadow: 0 8px 16px rgba(0, 0, 0, 0.15);
      margin: 10px 0;
    }

    @keyframes animatebackground {
      from {
        background-position: 0 0;
      }

      to {
        background-position: 100% 0;
      }

    }

    #blood-run-container {
      display: flex;
      flex-direction: column;
      align-items: center;
      width: 100%;
      height: 100%;
      background: linear-gradient(135deg, #ffe3e3 0%, #ffeaea 100%);
      padding: 20px;
      box-sizing: border-box;
    }

    .blood-run-complete {
      animation: successPulse 1s ease-in-out;
    }

    /* Game status indicators */
    #blood-run-status {
      transition: color 0.3s ease;
    }

    #blood-run-status.playing {
      color: #4caf50;
      font-weight: bold;
    }

    #blood-run-status.completed {
      color: #ff9800;
      font-weight: bold;
    }

    /* Tap Game Styles */
    #tap-game-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      background: linear-gradient(to bottom, #fff0f0, #ffe6e6);
      display: none;
      z-index: 2000;
      overflow: hidden;
    }

    #tap-game-container {
      position: relative;
      width: 100%;
      height: 100%;
      display: flex;
      justify-content: center;
      align-items: center;
      flex-direction: column;
      overflow: hidden;
    }

    #tap-canvas {
      background: #fdfdfd;
      border: 2px solid #ccc;
      border-radius: 10px;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
      position: relative;
      z-index: 1;
    }

    .help-btn-inline {
      background: linear-gradient(45deg, #667eea, #764ba2);
      color: white;
      border: none;
      border-radius: 50%;
      width: 35px;
      height: 35px;
      font-size: 16px;
      font-weight: bold;
      cursor: pointer;
      box-shadow: 0 2px 8px rgba(102, 126, 234, 0.4);
      transition: all 0.3s ease;
      margin-left: 15px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      vertical-align: middle;
    }

    .help-btn-inline:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.6);
      background: linear-gradient(45deg, #764ba2, #667eea);
    }


    #tap-hud {
      transition: color 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: flex-start;
      font-size: 20px;
      padding: 10px 15px;
      border-radius: 10px;
      background: rgba(255, 255, 255, 0.9);
      box-shadow: 2px 2px 10px rgba(0, 0, 0, 0.2);
      font-weight: bold;
      margin-bottom: 10px;
    }

    #tap-blood-bag-container {
      position: absolute;
      top: 20px;
      right: 20px;
      width: 150px;
      height: 200px;
      background: url('img/bagBlood.png') no-repeat center;
      background-size: cover;
      z-index: 1;
    }

    #tap-blood-fill {
      position: absolute;
      bottom: 600px;
      right: 48px;
      width: 95px;
      height: 0px;
      max-height: 104px;
      background: linear-gradient(to top, #d00, #ff4d4d);
      border-radius: 6px;
      transition: height 0.3s ease-out;
      z-index: 2;
    }

    /* Fade overlay untuk transisi */
    .fade-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      background: linear-gradient(45deg, #fafafa, #fc5757);
      opacity: 0;
      pointer-events: none;
      transition: opacity 1s ease;
      z-index: 1500;
      display: flex;
      justify-content: center;
      align-items: center;
      color: white;
      font-size: 24px;
      text-align: center;
      flex-direction: column;
    }

    .fade-overlay.active {
      opacity: 1;
      pointer-events: all;
    }

    @keyframes skillCheckFeedback {
      0% {
        opacity: 1;
        transform: translateX(-50%) translateY(0) scale(1);
      }

      50% {
        transform: translateX(-50%) translateY(-10px) scale(1.2);
      }

      100% {
        opacity: 0;
        transform: translateX(-50%) translateY(-30px) scale(0.8);
      }
    }

    .skill-check-container {
      font-family: 'Arial', sans-serif;
    }

    .skill-check-needle {
      transition: none;
    }

    .safe-zone,
    .bonus-zone {
      transition: all 0.3s ease;
    }

    .drop-zone-active {
      stroke: #4caf50 !important;
      stroke-width: 4 !important;
      fill: rgba(76, 175, 80, 0.2) !important;
    }

    .popup-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.8);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 2500;
      backdrop-filter: blur(5px);
    }

    .popup-container {
      background: linear-gradient(135deg, #ff9191 0%, #de5c5c 100%);
      border-radius: 20px;
      padding: 30px;
      max-width: 500px;
      width: 90%;
      position: relative;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
      border: 2px solid rgba(255, 255, 255, 0.2);
    }

    .popup-header {
      text-align: center;
      margin-bottom: 25px;
    }

    .popup-title {
      font-size: 28px;
      font-weight: bold;
      color: white;
      margin-bottom: 10px;
      text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
    }

    .popup-subtitle {
      font-size: 16px;
      color: rgba(255, 255, 255, 0.8);
    }

    .game-elements {
      display: flex;
      justify-content: space-around;
      margin: 25px 0;
    }

    .element {
      text-align: center;
      flex: 1;
      margin: 0 15px;
    }

    .element-icon {
      width: 80px;
      height: 80px;
      border-radius: 50%;
      margin: 0 auto 15px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 32px;
      font-weight: bold;
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
      animation: float 3s ease-in-out infinite;
    }

    .blood-element .element-icon {
      background: linear-gradient(45deg, #ff4757, #ff3742);
      color: white;
    }

    .bacteria-element .element-icon {
      background: linear-gradient(45deg, #2ed573, #1dd1a1);
      color: white;
    }

    .element-title {
      font-size: 18px;
      font-weight: bold;
      color: white;
      margin-bottom: 8px;
    }

    .element-desc {
      font-size: 14px;
      color: rgba(255, 255, 255, 0.9);
      line-height: 1.4;
    }

    .instructions {
      background: rgba(255, 255, 255, 0.1);
      border-radius: 15px;
      padding: 20px;
      margin: 25px 0;
      border: 1px solid rgba(255, 255, 255, 0.2);
    }

    .instruction-title {
      font-size: 20px;
      font-weight: bold;
      color: white;
      margin-bottom: 15px;
      text-align: center;
    }

    .instruction-list {
      list-style: none;
      padding: 0;
      margin: 0;
    }

    .instruction-item {
      display: flex;
      align-items: center;
      margin-bottom: 12px;
      color: rgba(255, 255, 255, 0.9);
      font-size: 14px;
    }

    .instruction-item:last-child {
      margin-bottom: 0;
    }

    .instruction-number {
      background: rgba(255, 255, 255, 0.2);
      color: white;
      width: 25px;
      height: 25px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      margin-right: 12px;
      font-size: 12px;
    }

    .popup-buttons {
      display: flex;
      gap: 15px;
      margin-top: 25px;
    }

    .btn-popup {
      flex: 1;
      padding: 12px 20px;
      border: none;
      border-radius: 25px;
      font-size: 16px;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.3s ease;
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    .btn-play {
      background: linear-gradient(45deg, #ff4757, #ff3742);
      color: white;
      box-shadow: 0 4px 15px rgba(255, 71, 87, 0.4);
    }

    .btn-play:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(255, 71, 87, 0.6);
    }

    .btn-close {
      background: rgba(255, 255, 255, 0.2);
      color: white;
      border: 2px solid rgba(255, 255, 255, 0.3);
    }

    .btn-close:hover {
      background: rgba(255, 255, 255, 0.3);
      transform: translateY(-2px);
    }

    .close-btn {
      position: absolute;
      top: 15px;
      right: 20px;
      background: none;
      border: none;
      color: rgba(255, 255, 255, 0.7);
      font-size: 24px;
      cursor: pointer;
      padding: 5px;
      border-radius: 50%;
      width: 35px;
      height: 35px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.3s ease;
    }

    .close-btn:hover {
      background: rgba(255, 255, 255, 0.1);
      color: white;
      transform: rotate(90deg);
    }

    @keyframes float {

      0%,
      100% {
        transform: translateY(0px);
      }

      50% {
        transform: translateY(-10px);
      }
    }

    .hidden {
      display: none;
    }

    /* Legend Container - Updated for PNG icons */
    .legend-container {
      position: absolute;
      bottom: 20px;
      left: 20px;
      background: rgba(0, 0, 0, 0.8);
      border-radius: 10px;
      padding: 15px;
      border: 2px solid rgba(255, 255, 255, 0.3);
      backdrop-filter: blur(5px);
      z-index: 10;
      max-width: 250px;
    }

    .legend-item {
      display: flex;
      align-items: center;
      margin-bottom: 10px;
      font-size: 14px;
      color: white;
    }

    .legend-item:last-child {
      margin-bottom: 0;
    }

    .legend-icon {
      width: 30px;
      height: 30px;
      border-radius: 50%;
      margin-right: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      overflow: hidden;
      border: 2px solid rgba(255, 255, 255, 0.3);
    }

    .legend-icon img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      border-radius: 50%;
    }

    /* Hide legend container initially */
    .legend-container.hidden {
      display: none;
    }

    /* Dropdown styles */
    .dropdown-menu {
      transition: all 0.3s ease;
      transform: translateY(-10px);
      opacity: 0;
      visibility: hidden;
    }

    .dropdown-menu.show {
      transform: translateY(0);
      opacity: 1;
      visibility: visible;
    }

    .dropdown-item:hover {
      background-color: #f3f4f6;
    }

    .bacteria-notification {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: linear-gradient(135deg, #ff4757, #ff3742);
      color: white;
      padding: 30px 40px;
      border-radius: 20px;
      box-shadow: 0 20px 40px rgba(255, 71, 87, 0.4);
      z-index: 3000;
      text-align: center;
      min-width: 400px;
      border: 3px solid rgba(255, 255, 255, 0.3);
      backdrop-filter: blur(10px);
      animation: popupSlideIn 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);
    }

    .bacteria-notification-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      background: rgba(0, 0, 0, 0.7);
      z-index: 2999;
      backdrop-filter: blur(5px);
      animation: fadeInOverlay 0.3s ease-out;
    }

    .bacteria-notification h3 {
      font-size: 28px;
      font-weight: bold;
      margin-bottom: 15px;
      text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
    }

    .bacteria-notification p {
      font-size: 16px;
      line-height: 1.5;
      margin-bottom: 25px;
      opacity: 0.9;
    }

    .bacteria-notification .bacteria-icon {
      font-size: 40px;
      animation: shakeIcon 0.6s ease-in-out;
    }

    .bacteria-notification button {
      background: rgba(255, 255, 255, 0.2);
      color: white;
      border: 2px solid rgba(255, 255, 255, 0.3);
      padding: 12px 30px;
      border-radius: 25px;
      font-size: 16px;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.3s ease;
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    .bacteria-notification button:hover {
      background: rgba(255, 255, 255, 0.3);
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
    }

    @keyframes popupSlideIn {
      0% {
        opacity: 0;
        transform: translate(-50%, -50%) scale(0.8) rotateY(-20deg);
      }

      50% {
        transform: translate(-50%, -50%) scale(1.05) rotateY(5deg);
      }

      100% {
        opacity: 1;
        transform: translate(-50%, -50%) scale(1) rotateY(0deg);
      }
    }

    @keyframes fadeInOverlay {
      from {
        opacity: 0;
      }

      to {
        opacity: 1;
      }
    }

    @keyframes shakeIcon {

      0%,
      100% {
        transform: rotate(0deg);
      }

      25% {
        transform: rotate(-10deg);
      }

      75% {
        transform: rotate(10deg);
      }
    }

    @keyframes popupSlideOut {
      0% {
        opacity: 1;
        transform: translate(-50%, -50%) scale(1);
      }

      100% {
        opacity: 0;
        transform: translate(-50%, -50%) scale(0.8) translateY(20px);
      }
    }

    .bacteria-notification.slide-out {
      animation: popupSlideOut 0.3s ease-in forwards;
    }

    .bacteria-notification-overlay.fade-out {
      animation: fadeInOverlay 0.3s ease-in reverse forwards;
    }

    .bacteria-notification .remember-highlight {
      background: rgba(255, 255, 255, 0.15);
      border: 2px solid rgba(255, 255, 255, 0.3);
      border-radius: 15px;
      padding: 15px 20px;
      margin: 15px 0;
      backdrop-filter: blur(5px);
      box-shadow: 0 8px 16px rgba(0, 0, 0, 0.2);
      position: relative;
      overflow: hidden;
    }

    .bacteria-notification .remember-highlight::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.1), transparent);
      animation: shimmer 2s infinite;
    }

    .bacteria-notification .remember-highlight strong {
      color: #fff;
      font-size: 18px;
      text-shadow: 0 2px 4px rgba(0, 0, 0, 0.5);
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }

    .bacteria-notification .remember-highlight .warning-icon {
      font-size: 20px;
      animation: pulse 2s infinite;
    }

    @keyframes shimmer {
      0% {
        left: -100%;
      }

      100% {
        left: 100%;
      }
    }

    @keyframes pulse {

      0%,
      100% {
        transform: scale(1);
        opacity: 1;
      }

      50% {
        transform: scale(1.1);
        opacity: 0.8;
      }
    }
  </style>
</head>

<body class="bg-gray-50 font-sans min-h-screen flex flex-col">
  <header class="bg-white text-black shadow-md sticky top-0 z-50">
    <div class="container mx-auto px-4 py-3">
      <div class="flex justify-between items-center">
        <!-- Logo Section -->
        <div class="flex items-center space-x-2">
          <img src="img/blood.png" alt="Blood Heroes Logo" class="h-8 w-8 rounded-full object-cover" />
          <span class="font-bold text-xl">PMI Blood Heroes</span>
        </div>

        <!-- Desktop Navigation -->
        <nav class="desktop-nav">
          <ul class="flex space-x-6">
            <li><a href="#home"
                class="text-gray-700 hover:text-red-600 py-2 px-3 rounded transition duration-300">Home</a></li>
            <li><a href="#games"
                class="text-gray-700 hover:text-red-600 py-2 px-3 rounded transition duration-300">Games</a></li>
            <li><a href="#education"
                class="text-gray-700 hover:text-red-600 py-2 px-3 rounded transition duration-300">Education</a></li>
            <li><a href="#leaderboard"
                class="text-gray-700 hover:text-red-600 py-2 px-3 rounded transition duration-300">Leaderboard</a></li>
            <li><a href="#blood-stock"
                class="text-gray-700 hover:text-red-600 py-2 px-3 rounded transition duration-300">Blood Stock</a></li>
          </ul>
        </nav>

        <!-- Right Side: Profile + Mobile Menu -->
        <div class="flex items-center space-x-3">
          <!-- Profile Dropdown -->
          <div class="profile-container relative">
            <button id="profileButton" class="focus:outline-none">
              <div class="relative w-10 h-10 rounded-full overflow-hidden">
                <img src="img/user.png" alt="User Profile" class="w-full h-full object-cover" />
              </div>
            </button>

            <!-- Dropdown Menu -->
            <div id="dropdownMenu"
              class="dropdown-menu absolute right-0 top-12 bg-white rounded-lg shadow-lg w-64 z-50 border border-gray-200">
              <div class="user-info flex items-center p-4 border-b border-gray-200">
                <div class="w-10 h-10 rounded-full overflow-hidden mr-3">
                  <img src="img/user.png" alt="User Profile" class="w-full h-full object-cover" />
                </div>
                <div class="user-details">
                  <span class="font-semibold text-sm">Budi Budiman</span>
                </div>
              </div>

              <a href="profile.html"
                class="dropdown-item flex items-center px-4 py-3 text-gray-800 hover:bg-gray-100 text-sm">
                <span class="mr-3 w-5 text-center">👤</span> Profile
              </a>

              <a href="reward.html"
                class="dropdown-item flex items-center px-4 py-3 text-blue-500 hover:bg-gray-100 text-sm">
                <span class="mr-3 w-5 text-center">🪙</span> Reedem Points
              </a>

              <div class="border-t border-gray-200 my-1"></div>

              <a href="#" class="dropdown-item flex items-center px-4 py-3 text-gray-800 hover:bg-gray-100 text-sm">
                <span class="mr-3 w-5 text-center">❌</span> Log out
              </a>

              <div class="flex justify-start p-4">
                <div class="w-10 h-10 rounded-full overflow-hidden">
                  <i class="fas fa-coins text-yellow-500 text-3xl"></i>
                </div>
                <span class="font-medium text-sm ml-3">304 Points</span>
              </div>
            </div>
          </div>

          <!-- Mobile Menu Button -->
          <button class="mobile-nav text-gray-700 focus:outline-none" id="mobile-menu-button">
            <i class="fas fa-bars text-xl"></i>
          </button>
        </div>
      </div>

      <!-- Mobile Navigation -->
      <div class="mobile-nav hidden bg-white px-4 py-2 mt-4 border-t border-gray-200" id="mobile-menu">
        <ul class="space-y-2">
          <li><a href="#home"
              class="block py-2 px-3 text-gray-700 hover:text-red-600 hover:bg-gray-100 rounded transition duration-300">Home</a>
          </li>
          <li><a href="#games"
              class="block py-2 px-3 text-gray-700 hover:text-red-600 hover:bg-gray-100 rounded transition duration-300">Games</a>
          </li>
          <li><a href="#education"
              class="block py-2 px-3 text-gray-700 hover:text-red-600 hover:bg-gray-100 rounded transition duration-300">Education</a>
          </li>
          <li><a href="#leaderboard"
              class="block py-2 px-3 text-gray-700 hover:text-red-600 hover:bg-gray-100 rounded transition duration-300">Leaderboard</a>
          </li>
          <li><a href="#blood-stock"
              class="block py-2 px-3 text-gray-700 hover:text-red-600 hover:bg-gray-100 rounded transition duration-300">Blood
              Stock</a></li>
        </ul>
      </div>
    </div>
  </header>

  <section class="hero-slider" id="home">
    <!-- Slide 1 -->
    <div class="relative h-full">
      <div class="absolute inset-0 bg-cover bg-center" style="background-image: url('img/hospital.png')"></div>
      <div class="absolute inset-0 bg-black opacity-50"></div>
      <div class="container mx-auto px-4 h-full flex items-center justify-center">
        <div class="relative z-10 max-w-3xl text-center text-white">
          <span class="slide-badge">Join Today</span>
          <h1 class="text-4xl md:text-5xl font-bold mb-6">Become a Blood Donation Hero</h1>
          <p class="text-xl mb-8">
            Play and learn about the importance of blood donation. Earn points, challenge friends, and
            discover how one
            blood bag can save up to three lives!
          </p>
          <div class="flex flex-col sm:flex-row justify-center space-y-4 sm:space-y-0 sm:space-x-4">
            <a href="#games"
              class="bg-white text-red-600 font-bold py-3 px-8 rounded-full shadow-lg hover:bg-gray-100 transition duration-300">Start
              Playing</a>
            <a href="#education"
              class="bg-transparent border-2 border-white py-3 px-8 rounded-full hover:bg-white hover:text-red-600 transition duration-300">Learn
              About Blood Donation</a>
          </div>
        </div>
      </div>
    </div>

    <!-- Slide 2 -->
    <div class="relative h-full">
      <div class="absolute inset-0 bg-cover bg-center" style="background-image: url('img/donors.jpg')"></div>
      <div class="absolute inset-0 bg-black opacity-50"></div>
      <div class="container mx-auto px-4 h-full flex items-center justify-center">
        <div class="relative z-10 max-w-3xl text-center text-white">
          <span class="slide-badge">Did You Know?</span>
          <h1 class="text-4xl md:text-5xl font-bold mb-6">One Donation Saves 3 Lives</h1>
          <p class="text-xl mb-8">
            Your single donation can be separated into red cells, platelets, and plasma
            to help multiple patients with different medical needs.
          </p>
          <div class="flex flex-col sm:flex-row justify-center space-y-4 sm:space-y-0 sm:space-x-4">
            <a href="donasi.html"
              class="bg-white text-red-600 font-bold py-3 px-8 rounded-full shadow-lg hover:bg-gray-100 transition duration-300">Schedule
              Donation</a>
          </div>
        </div>
      </div>
    </div>

    <!-- Slide 3 -->
    <div class="relative h-full">
      <div class="absolute inset-0 bg-cover bg-center" style="background-image: url('img/points.png')"></div>
      <div class="absolute inset-0 bg-black opacity-50"></div>
      <div class="container mx-auto px-4 h-full flex items-center justify-center">
        <div class="relative z-10 max-w-3xl text-center text-white">
          <span class="slide-badge">Donor Rewards</span>
          <h1 class="text-4xl md:text-5xl font-bold mb-6">Earn Points While Saving Lives</h1>
          <p class="text-xl mb-8">
            Join our Donor Rewards Program and earn points for each donation.
            Redeem them for exclusive merchandise, gift cards, and more!
          </p>
          <div class="flex flex-col sm:flex-row justify-center space-y-4 sm:space-y-0 sm:space-x-4">
            <a href="reward.html"
              class="bg-white text-red-600 font-bold py-3 px-8 rounded-full shadow-lg hover:bg-gray-100 transition duration-300">View
              Rewards</a>
          </div>
        </div>
      </div>
    </div>
  </section>

  <section class="py-16 px-4 bg-white">
    <div class="container mx-auto">
      <h2 class="text-3xl font-bold text-center text-gray-800 mb-12">Main Features</h2>
      <div class="grid md:grid-cols-3 gap-8">
        <!-- Card 1 -->
        <div
          class="bg-white rounded-xl shadow-lg overflow-hidden hover:shadow-xl transition-all duration-300 ease-in transform hover:-translate-y-1 card-animate">
          <div class="bg-red-100 p-6 text-center">
            <i class="fas fa-gamepad text-4xl text-red-600"></i>
          </div>
          <div class="p-6">
            <h3 class="text-xl font-bold text-gray-800 mb-3">Blood Donation Simulation</h3>
            <p class="text-gray-600 mb-4">
              Experience what it's like to be a medical professional managing the blood donation process,
              from screening to distribution.
            </p>
            <a href="#simulation"
              class="block text-center bg-red-600 text-white py-2 px-4 rounded-lg hover:bg-red-700 transition duration-300">Play
              Now</a>
          </div>
        </div>

        <!-- Card 2 -->
        <div
          class="bg-white rounded-xl shadow-lg overflow-hidden hover:shadow-xl transition-all duration-300 ease-in transform hover:-translate-y-1 card-animate">
          <div class="bg-red-100 p-6 text-center">
            <i class="fas fa-question-circle text-4xl text-red-600"></i>
          </div>
          <div class="p-6">
            <h3 class="text-xl font-bold text-gray-800 mb-3">Interactive Quiz</h3>
            <p class="text-gray-600 mb-4">
              Test your knowledge about blood donation through quizzes with various difficulty levels and
              earn virtual rewards.
            </p>
            <a href="#quiz"
              class="block text-center bg-red-600 text-white py-2 px-4 rounded-lg hover:bg-red-700 transition duration-300">Play
              Now</a>
          </div>
        </div>

        <!-- Card 3 -->
        <div
          class="bg-white rounded-xl shadow-lg overflow-hidden hover:shadow-xl transition-all duration-300 ease-in transform hover:-translate-y-1 card-animate">
          <div class="bg-red-100 p-6 text-center">
            <i class="fas fa-book-medical text-4xl text-red-600"></i>
          </div>
          <div class="p-6">
            <h3 class="text-xl font-bold text-gray-800 mb-3">Educational Materials</h3>
            <p class="text-gray-600 mb-4">
              Learn about different blood products, blood needs, storage, processing, and blood donation
              activities.
            </p>
            <a href="#education"
              class="block text-center bg-red-600 text-white py-2 px-4 rounded-lg hover:bg-red-700 transition duration-300">Learn
              More</a>
          </div>
        </div>
      </div>
    </div>
  </section>


  <section class="py-16 px-4 bg-white" id="games">
    <div class="container mx-auto">
      <h2 class="text-3xl font-bold text-center text-gray-800 mb-12">Educational Games</h2>

      <div class="bg-white rounded-xl shadow-lg overflow-hidden">
        <div class="flex border-b">
          <button
            class="py-4 px-6 font-medium text-gray-800 bg-gray-200 hover:bg-gray-300 transition duration-300 focus:outline-none"
            id="sim-tab">
            Blood Donation Simulation
          </button>
          <button
            class="py-4 px-6 font-medium text-gray-800 hover:bg-gray-200 transition duration-300 focus:outline-none"
            id="quiz-tab">
            Interactive Quiz
          </button>
        </div>

        <div id="simulation">
          <div class="scene">
            <div class="scene-content" id="scene-content">
              <div class="patient" style="position: relative; width: 500px; height: 350px;">
                <img src="img/patient.png" alt="Patient" class="patient-image" style="width: 100%; height: 100%;" />

                <!-- Area klik lengan -->
                <div id="arm" style="position: absolute; top: 130px; left: 215px; width: 120px; height: 35px; 
              cursor: pointer; background-color: rgba(255, 255, 255, 0); z-index: 4;">
                </div>

                <!-- Cleaned area dan bandage -->
                <div id="cleaned-area"
                  style="display: none; position: absolute; top: 130px; left: 215px; width: 30px; height: 30px; background: rgba(200, 230, 255, 0.5); border-radius: 50%; z-index: 6;">
                </div>
                <div id="bandage"
                  style="display: none; position: absolute; top: 135px; left: 210px; width: 40px; height: 20px; background: #F1D3B2; border: 1px solid #F1D3B2; border-radius: 5px; z-index: 7; transform: rotate(90deg);">
                </div>
              </div>


              <div class="blood-sample" id="blood-sample">

                <img src="img/serum.png" alt="Blood Sample" style="width: 80px; height: 100px;">

              </div>

              <div class="test-result" id="test-result"></div>

              <div class="patient-target" id="patient-target">
                <svg width="200" height="350" viewBox="0 0 200 350">
                  <!-- Patient body -->
                  <rect x="50" y="50" width="100" height="200" rx="20" fill="#f5cba7" />
                  <!-- Patient head -->
                  <circle cx="100" cy="30" r="30" fill="#f5cba7" />
                  <!-- Patient details -->
                  <circle cx="90" cy="25" r="3" fill="#424242" /> <!-- Left eye -->
                  <circle cx="110" cy="25" r="3" fill="#424242" /> <!-- Right eye -->
                  <path d="M95 45 Q100 40 105 45" stroke="#424242" stroke-width="2" fill="none" />
                  <!-- Frown (sick) -->
                </svg>
                <div class="arm">
                  <svg width="100" height="150" viewBox="0 0 100 150">
                    <!-- Arm -->
                    <rect x="10" y="10" width="40" height="130" rx="20" fill="#f5cba7" />
                    <!-- Vein -->
                    <path d="M25 40 L25 120" class="vein" />
                    <!-- IV insertion point (initially hidden) -->
                    <circle id="iv-point" cx="25" cy="80" r="5" fill="#e53935" style="display: none;" />
                  </svg>
                </div>
              </div>

              <div class="blood-bag" id="blood-bag">
                <svg width="80" height="100" viewBox="0 0 80 100">
                  <!-- Blood bag -->
                  <path d="M5 5 L45 5 L45 35 Q25 45 5 35 Z" fill="#e53935" stroke="#7b1fa2" stroke-width="2" />
                  <!-- Blood type label -->
                  <circle cx="25" cy="20" r="8" fill="white" stroke="#7b1fa2" stroke-width="1" />
                  <text id="blood-type-text" x="25" y="23" text-anchor="middle" font-weight="bold"
                    font-size="8">A+</text>
                  <!-- Tube -->
                  <path d="M25 45 L25 50" stroke="white" stroke-width="2" />
                  <!-- Drip -->
                  <circle id="drip" cx="25" cy="52" r="1" fill="#e53935" style="display: none;" />
                </svg>
              </div>

              <!-- Laboratory scene -->
              <div class="laboratory" id="laboratory">
                <svg width="800" height="450" viewBox="0 0 800 450">
                  <!-- Lab equipment background -->
                  <rect x="50" y="50" width="700" height="300" rx="5" fill="#e0e0e0" stroke="#bdbdbd"
                    stroke-width="2" />

                  <!-- Blood sample in lab -->
                  <g transform="translate(150, 150)" id="lab-blood-sample">
                    <image href="img/serum.png" x="-80" y="-40" width="80" height="100" />
                  </g>

                  <!-- Blood testing kit -->
                  <g transform="translate(350, 200)" id="test-plates">
                    <!-- A plate -->
                    <g class="test-plate" id="test-plate-a" data-type="A">
                      <circle cx="-120" cy="0" r="30" fill="#f5f5f5" stroke="#bdbdbd" stroke-width="2" />
                      <text x="-120" y="5" text-anchor="middle" font-size="16" font-weight="bold">A</text>
                      <!-- Reagent (light yellow) -->
                      <circle cx="-120" cy="0" r="25" fill="#fff9c4" fill-opacity="0.6" />
                      <!-- Coagulation result (initially hidden) -->
                      <g id="result-a" style="display: none;">
                        <circle cx="-120" cy="0" r="15" fill="#e53935" fill-opacity="0.7"
                          class="coagulation-positive" />
                        <path d="M-130 -10 L-110 10 M-130 10 L-110 -10" stroke="#8d0000" stroke-width="2" />
                      </g>
                    </g>

                    <!-- B plate -->
                    <g class="test-plate" id="test-plate-b" data-type="B">
                      <circle cx="0" cy="0" r="30" fill="#f5f5f5" stroke="#bdbdbd" stroke-width="2" />
                      <text x="0" y="5" text-anchor="middle" font-size="16" font-weight="bold">B</text>
                      <!-- Reagent (light blue) -->
                      <circle cx="0" cy="0" r="25" fill="#bbdefb" fill-opacity="0.6" />
                      <!-- Coagulation result (initially hidden) -->
                      <g id="result-b" style="display: none;">
                        <circle cx="0" cy="0" r="15" fill="#e53935" fill-opacity="0.7" class="coagulation-positive" />
                        <path d="M-10 -10 L10 10 M-10 10 L10 -10" stroke="#8d0000" stroke-width="2" />
                      </g>
                    </g>

                    <!-- Rh plate -->
                    <g class="test-plate" id="test-plate-rh" data-type="Rh">
                      <circle cx="120" cy="0" r="30" fill="#f5f5f5" stroke="#bdbdbd" stroke-width="2" />
                      <text x="120" y="5" text-anchor="middle" font-size="16" font-weight="bold">Rh</text>
                      <!-- Reagent (light green) -->
                      <circle cx="120" cy="0" r="25" fill="#c8e6c9" fill-opacity="0.6" />
                      <!-- Coagulation result (initially hidden) -->
                      <g id="result-rh" style="display: none;">
                        <circle cx="120" cy="0" r="15" fill="#e53935" fill-opacity="0.7" class="coagulation-positive" />
                        <path d="M110 -10 L130 10 M110 10 L130 -10" stroke="#8d0000" stroke-width="2" />
                      </g>
                    </g>
                  </g>
                </svg>
              </div>

              <!-- Transfusion room scene -->
              <div class="transfusion-room" id="transfusion-room">
                <svg width="800" height="450" viewBox="0 0 800 450">
                  <!-- Background wall elements -->
                  <rect x="0" y="0" width="800" height="450" fill="#e8f5e9" />

                  <!-- Medical equipment - adds realism -->
                  <rect x="650" y="150" width="80" height="40" rx="5" fill="#e0e0e0" stroke="#bdbdbd" />
                  <circle cx="670" cy="170" r="5" fill="#4caf50" />
                  <rect x="680" y="165" width="40" height="10" rx="2" fill="#f5f5f5" />
                </svg>

                <!-- Patient dengan gambar - menggantikan hospital bed dan patient SVG -->
                <div class="patient-in-bed"
                  style="position: absolute; top: 110px; left: 40px; width: 500px; height: 350px;">
                  <!-- di ubah -->
                  <img src="img/pasien2.png" alt="Patient" class="patient-image" style="width: 100%; height: 100%;" />

                  <!-- Area klik lengan - menggunakan ID lama -->
                  <div id="transfusion-point" style="position: absolute; top: 130px; left: 215px; width: 120px; height: 35px; 
          cursor: pointer; background-color: rgba(255, 255, 255, 0); z-index: 4;">
                  </div>
                </div>

                <!-- IV Stand - repositioned to match the image -->
                <div style="position: absolute; top: 100px; left: 520px;">
                  <svg width="100" height="300" viewBox="0 0 100 300">
                    <g class="transfusion-stand" id="transfusion-stand">
                      <!-- Stand pole -->
                      <rect x="45" y="30" width="10" height="200" fill="#757575" stroke="#424242" stroke-width="1" />
                      <!-- Stand base -->
                      <path d="M15 230 L85 230 L70 250 L30 250 Z" fill="#757575" stroke="#424242" stroke-width="1" />
                      <!-- Hook -->
                      <path d="M55 30 L75 30 L75 50" fill="none" stroke="#757575" stroke-width="3" />

                      <!-- Drop zone -->
                      <rect id="drop-zone" x="65" y="35" width="35" height="50" stroke="#e53935" stroke-width="3"
                        stroke-dasharray="5" fill="rgba(255,235,238,0.3)" rx="5" class="drop-zone-highlight" />

                      <!-- Instruction text -->
                      <text id="instruction-text" x="90" y="65" text-anchor="middle" font-size="10" fill="#d32f2f"
                        transform="rotate(-90, 90, 65)">Pasang di
                        sini</text>
                    </g>
                  </svg>
                </div>
              </div>

              <div class="blood-run-game" id="blood-run-game">
                <div id="blood-run-container">
                  <canvas id="blood-run-canvas" width="700" height="220"></canvas>
                  <div
                    style="margin-top: 50px; text-align: center; background: rgba(255,255,255,0.8); padding: 10px; border-radius: 10px;">
                    <div id="blood-run-instructions"
                      style="color: #333; font-size: 16px; margin-bottom: 8px; font-weight: bold;">
                      🎮 Press SPACE to jump • Collect 🩸 blood • Avoid obstacles • Reach the 🏥
                      hospital!
                    </div>
                  </div>
                </div>
              </div>

              <!-- Transition overlay -->
              <div class="transition-overlay" id="transition-overlay">
                <div class="stage-title" id="stage-title">Stage Title</div>
                <div class="stage-desc" id="stage-desc">Stage description goes here with important
                  information about
                  this stage.</div>
              </div>
            </div>
          </div>

          <div class="controls" id="controls">
          </div>

          <div id="blood-type-selection-container"
            class="bg-white rounded-lg shadow-md p-4 mb-4 hidden transition-all duration-300">

            <h3 class="text-lg font-bold text-center text-gray-800 mb-3">Determine blood type:</h3>

            <!-- Tombol Golongan Darah  -->
            <div class="flex justify-center space-x-3 mb-4">
              <button id="btn-a"
                class="blood-type-btn w-16 h-12 border-2 border-gray-300 rounded-md hover:bg-red-50 hover:border-red-500 focus:outline-none transition-all duration-200 font-bold text-lg text-red-800">A</button>
              <button id="btn-b"
                class="blood-type-btn w-16 h-12 border-2 border-gray-300 rounded-md hover:bg-red-50 hover:border-red-500 focus:outline-none transition-all duration-200 font-bold text-lg text-red-800">B</button>
              <button id="btn-ab"
                class="blood-type-btn w-16 h-12 border-2 border-gray-300 rounded-md hover:bg-red-50 hover:border-red-500 focus:outline-none transition-all duration-200 font-bold text-lg text-red-800">AB</button>
              <button id="btn-o"
                class="blood-type-btn w-16 h-12 border-2 border-gray-300 rounded-md hover:bg-red-50 hover:border-red-500 focus:outline-none transition-all duration-200 font-bold text-lg text-red-800">O</button>
            </div>

            <!-- Tombol Rhesus -->
            <h3 class="text-lg font-bold text-center text-gray-800 mb-3">Determmine Rhesus:</h3>
            <div class="flex justify-center space-x-3 mb-4">
              <button id="btn-rh-pos"
                class="rh-btn w-16 h-12 border-2 border-gray-300 rounded-md hover:bg-red-50 hover:border-red-500 focus:outline-none transition-all duration-200 font-bold text-lg text-red-800">Rh+</button>
              <button id="btn-rh-neg"
                class="rh-btn w-16 h-12 border-2 border-gray-300 rounded-md hover:bg-red-50 hover:border-red-500 focus:outline-none transition-all duration-200 font-bold text-lg text-red-800">Rh-</button>
            </div>

            <!-- Tombol Konfirmasi -->
            <div id="confirm-selection" class="flex justify-center hidden">
              <button id="btn-confirm"
                class="w-40 h-12 bg-red-600 text-white font-bold rounded-md hover:bg-red-700 focus:outline-none transform hover:scale-105 transition-all duration-200 flex items-center justify-center">
                <span>Confirm</span>
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 ml-2" viewBox="0 0 20 20" fill="currentColor">
                  <path fill-rule="evenodd"
                    d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z"
                    clip-rule="evenodd" />
                </svg>
              </button>
            </div>
          </div>

          <!-- Tampilan Hasil Tes -->
          <div id="test-result-display"
            class="bg-white rounded-lg shadow-md p-5 mb-4 hidden transition-all duration-500 transform">
            <h3 id="result-text" class="text-xl font-bold text-center text-gray-800 mb-2">Blood Type: ?</h3>
            <div class="flex justify-center">
              <div class="w-20 h-20 bg-red-100 rounded-full flex items-center justify-center">
                <span id="result-blood-type" class="text-3xl font-bold text-red-600">?</span>
              </div>
            </div>
          </div>

          <div class="message" id="message">Choose a tool to start blood donation</div>

          <button class="btn" id="next-btn" disabled>Next</button>

          <div class="alert" id="alert">Alert message</div>
        </div>

        <div id="quiz" class="hidden p-6">
          <!-- Quiz intro screen -->
          <div id="quiz-intro" class="text-center py-8">
            <h3 class="text-2xl font-bold text-gray-800 mb-4">Blood Donation Quiz</h3>

            <div class="mb-8 text-left max-w-md mx-auto">
              <h3 class="text-xl font-bold text-gray-700 mb-4">Quiz Rules:</h3>
              <ul class="space-y-2 text-gray-600">
                <li class="flex items-start">
                  <div
                    class="flex-shrink-0 w-6 h-6 rounded-full bg-green-100 flex items-center justify-center mr-2 mt-0.5">
                    <span class="text-green-600 font-bold text-xs">E</span>
                  </div>
                  <span><b>3 Easy Questions</b> - 10 points each</span>
                </li>
                <li class="flex items-start">
                  <div
                    class="flex-shrink-0 w-6 h-6 rounded-full bg-yellow-100 flex items-center justify-center mr-2 mt-0.5">
                    <span class="text-yellow-600 font-bold text-xs">M</span>
                  </div>
                  <span><b>2 Medium Questions</b> - 20 points each</span>
                </li>
                <li class="flex items-start">
                  <div
                    class="flex-shrink-0 w-6 h-6 rounded-full bg-red-100 flex items-center justify-center mr-2 mt-0.5">
                    <span class="text-red-600 font-bold text-xs">H</span>
                  </div>
                  <span><b>1 Hard Question</b> - 30 points each</span>
                </li>
                <li class="pt-2">
                  <b>Total possible:</b> 100 points per game
                </li>
              </ul>
            </div>

            <p class="text-gray-600 mb-8">Test your knowledge about blood donation with this interactive
              quiz!</p>

            <button id="start-quiz"
              class="bg-red-600 text-white py-3 px-8 rounded-lg hover:bg-red-700 transition duration-300 pulse-animation">
              Start Quiz
            </button>
          </div>

          <!-- Quiz container -->
          <div id="quiz-container" class="hidden">
            <!-- Progress bar -->
            <div class="flex items-center justify-between mb-2">
              <span class="text-sm text-gray-600">Question <span id="current-question">1</span> of <span
                  id="total-questions">3</span></span>
              <span class="text-sm text-gray-600">Score: <span id="quiz-score">0</span></span>
            </div>
            <div class="w-full bg-gray-200 rounded-full h-2.5 mb-6">
              <div id="quiz-progress" class="bg-red-600 h-2.5 rounded-full" style="width: 33%"></div>
            </div>

            <!-- Question container -->
            <div id="question-container">
              <h3 id="question-text" class="text-xl font-bold text-gray-800 mb-6">
                How long does it take for the body to replace plasma after donating blood?
              </h3>
              <div id="options-container" class="space-y-3 mb-6">
                <!-- Options will be inserted here by JavaScript -->
              </div>
              <div class="flex justify-between">
                <button id="next-question"
                  class="bg-red-600 text-white py-2 px-6 rounded-lg hover:bg-red-700 transition duration-300 hidden">
                  Next Question
                </button>
                <button id="submit-answer"
                  class="bg-red-600 text-white py-2 px-6 rounded-lg hover:bg-red-700 transition duration-300">
                  Submit Answer
                </button>
              </div>
            </div>
          </div>

          <!-- Results screen -->
          <div id="quiz-results" class="hidden text-center py-8">
            <div id="success-icon" class="mx-auto mb-6 text-green-500">
              <i class="fas fa-trophy text-6xl"></i>
            </div>
            <h3 class="text-2xl font-bold text-gray-800 mb-4">Quiz Complete!</h3>
            <p class="text-xl mb-2">Your score: <span id="final-score">0</span></p>
            <p id="result-message" class="text-gray-600 mb-6">Well done!</p>
            <p class="text-green-600 mb-8 text-lg font-bold hidden" id="points-earned">
              +<span id="points-value">30</span> points earned!
            </p>
            <div class="flex flex-col sm:flex-row justify-center space-y-4 sm:space-y-0 sm:space-x-4">
              <button id="retry-quiz"
                class="bg-red-600 text-white py-2 px-6 rounded-lg hover:bg-red-700 transition duration-300">
                Try Again
              </button>
              <button id="back-to-home"
                class="bg-gray-600 text-white py-2 px-6 rounded-lg hover:bg-gray-700 transition duration-300">
                Back to Home
              </button>
            </div>
          </div>

          <!-- Feedback alert -->
          <div id="feedback-alert"
            class="hidden mt-4 p-4 rounded-lg bg-green-100 border border-green-300 text-green-800">
            <p id="feedback-text" class="font-semibold"></p>
            <p id="feedback-explanation" class="text-sm mt-2"></p>
          </div>
        </div>
      </div>
    </div>
  </section>

  <section class="py-16 px-4 bg-white" id="leaderboard">
    <div class="container mx-auto">
      <h2 class="text-3xl font-bold text-center text-gray-800 mb-12">Leaderboard</h2>

      <div class="grid md:grid-cols-2 gap-8">
        <div class="bg-white rounded-xl shadow-lg overflow-hidden">
          <h3 class="bg-red-600 text-white text-xl font-bold py-4 px-6">Blood Donation Simulation</h3>
          <ul class="divide-y divide-gray-200">
            <li class="flex items-center p-4">
              <div class="bg-red-600 text-white rounded-full w-8 h-8 flex items-center justify-center font-bold mr-4">
                1
              </div>
              <div class="flex items-center flex-grow">
                <div class="bg-gray-200 rounded-full w-8 h-8 flex items-center justify-center mr-3">R
                </div>
                <span class="font-medium">Rizky_88</span>
              </div>
              <div class="font-bold">950</div>
            </li>
            <li class="flex items-center p-4">
              <div class="bg-gray-400 text-white rounded-full w-8 h-8 flex items-center justify-center font-bold mr-4">
                2
              </div>
              <div class="flex items-center flex-grow">
                <div class="bg-gray-200 rounded-full w-8 h-8 flex items-center justify-center mr-3">A
                </div>
                <span class="font-medium">Andi123</span>
              </div>
              <div class="font-bold">820</div>
            </li>
            <li class="flex items-center p-4">
              <div
                class="bg-yellow-700 text-white rounded-full w-8 h-8 flex items-center justify-center font-bold mr-4">
                3
              </div>
              <div class="flex items-center flex-grow">
                <div class="bg-gray-200 rounded-full w-8 h-8 flex items-center justify-center mr-3">F
                </div>
                <span class="font-medium">Fitri_PMI</span>
              </div>
              <div class="font-bold">790</div>
            </li>
            <li class="flex items-center p-4">
              <div class="text-gray-600 rounded-full w-8 h-8 flex items-center justify-center font-bold mr-4">
                4</div>
              <div class="flex items-center flex-grow">
                <div class="bg-gray-200 rounded-full w-8 h-8 flex items-center justify-center mr-3">S
                </div>
                <span class="font-medium">SandiW</span>
              </div>
              <div class="font-bold">715</div>
            </li>
            <li class="flex items-center p-4">
              <div class="text-gray-600 rounded-full w-8 h-8 flex items-center justify-center font-bold mr-4">
                5</div>
              <div class="flex items-center flex-grow">
                <div class="bg-gray-200 rounded-full w-8 h-8 flex items-center justify-center mr-3">D
                </div>
                <span class="font-medium">DewiAnggraini</span>
              </div>
              <div class="font-bold">690</div>
            </li>
          </ul>
        </div>

        <div class="bg-white rounded-xl shadow-lg overflow-hidden">
          <h3 class="bg-red-600 text-white text-xl font-bold py-4 px-6">Blood Donation Quiz</h3>
          <ul class="divide-y divide-gray-200">
            <li class="flex items-center p-4">
              <div class="bg-red-600 text-white rounded-full w-8 h-8 flex items-center justify-center font-bold mr-4">
                1
              </div>
              <div class="flex items-center flex-grow">
                <div class="bg-gray-200 rounded-full w-8 h-8 flex items-center justify-center mr-3">B
                </div>
                <span class="font-medium">Budi_Smart</span>
              </div>
              <div class="font-bold">850</div>
            </li>
            <li class="flex items-center p-4">
              <div class="bg-gray-400 text-white rounded-full w-8 h-8 flex items-center justify-center font-bold mr-4">
                2
              </div>
              <div class="flex items-center flex-grow">
                <div class="bg-gray-200 rounded-full w-8 h-8 flex items-center justify-center mr-3">S
                </div>
                <span class="font-medium">Sinta22</span>
              </div>
              <div class="font-bold">810</div>
            </li>
            <li class="flex items-center p-4">
              <div
                class="bg-yellow-700 text-white rounded-full w-8 h-8 flex items-center justify-center font-bold mr-4">
                3
              </div>
              <div class="flex items-center flex-grow">
                <div class="bg-gray-200 rounded-full w-8 h-8 flex items-center justify-center mr-3">M
                </div>
                <span class="font-medium">Maya_SMA</span>
              </div>
              <div class="font-bold">780</div>
            </li>
            <li class="flex items-center p-4">
              <div class="text-gray-600 rounded-full w-8 h-8 flex items-center justify-center font-bold mr-4">
                4</div>
              <div class="flex items-center flex-grow">
                <div class="bg-gray-200 rounded-full w-8 h-8 flex items-center justify-center mr-3">R
                </div>
                <span class="font-medium">Rudi_PMI</span>
              </div>
              <div class="font-bold">760</div>
            </li>
            <li class="flex items-center p-4">
              <div class="text-gray-600 rounded-full w-8 h-8 flex items-center justify-center font-bold mr-4">
                5</div>
              <div class="flex items-center flex-grow">
                <div class="bg-gray-200 rounded-full w-8 h-8 flex items-center justify-center mr-3">D
                </div>
                <span class="font-medium">Dinda09</span>
              </div>
              <div class="font-bold">705</div>
            </li>
          </ul>
        </div>
      </div>
    </div>
  </section>

  <section class="py-16 px-4 bg-white" id="education">
    <div class="container mx-auto">
      <h2 class="text-3xl font-bold text-center text-gray-800 mb-12">Blood Donation Education</h2>

      <div class="bg-white rounded-xl shadow-lg overflow-hidden">
        <div class="flex flex-wrap border-b">
          <button
            class="education-tab py-3 px-4 font-medium text-gray-800 bg-gray-200 hover:bg-gray-300 transition duration-300 focus:outline-none text-sm md:text-base"
            data-tab="human-body">
            Human Body
          </button>
          <button
            class="education-tab py-3 px-4 font-medium text-gray-800 hover:bg-gray-200 transition duration-300 focus:outline-none text-sm md:text-base"
            data-tab="blood-products">
            Blood Products
          </button>
          <button
            class="education-tab py-3 px-4 font-medium text-gray-800 hover:bg-gray-200 transition duration-300 focus:outline-none text-sm md:text-base"
            data-tab="blood-needs">
            Blood Needs
          </button>
          <button
            class="education-tab py-3 px-4 font-medium text-gray-800 hover:bg-gray-200 transition duration-300 focus:outline-none text-sm md:text-base"
            data-tab="storage">
            Storage
          </button>
          <button
            class="education-tab py-3 px-4 font-medium text-gray-800 hover:bg-gray-200 transition duration-300 focus:outline-none text-sm md:text-base"
            data-tab="processing">
            Processing
          </button>
          <button
            class="education-tab py-3 px-4 font-medium text-gray-800 hover:bg-gray-200 transition duration-300 focus:outline-none text-sm md:text-base"
            data-tab="donation-process">
            Donation Process
          </button>
        </div>

        <!-- Human Body Tab -->
        <div class="education-content p-6" id="human-body-content">
          <h3 class="text-2xl font-bold text-gray-800 mb-6">Understanding the Human Body</h3>

          <h4 class="text-xl font-bold text-gray-700 mb-2">The Circulatory System</h4>
          <div class="flex flex-col md:flex-row gap-6 mb-8">
            <div class="md:w-2/3">
              <p class="text-black-600 mb-4">
                The circulatory system is the body's transportation network, responsible for delivering
                oxygen,
                nutrients, hormones, and immune cells to tissues while removing waste products.
              </p>
              <p class="text-black-600 mb-4">
                At the center of this system is the heart, a powerful muscle that pumps blood throughout
                the body. The
                average adult has about 5-6 liters of blood circulating in their body.
              </p>
            </div>
            <div class="md:w-1/3">
              <img src="img/human-circulatory.png" alt="Circulatory System"
                class="w-full h-auto rounded-lg shadow-md" />
            </div>
          </div>

          <h4 class="text-2xl font-bold text-gray-700 mb-2">Blood: The River of Life</h4>
          <p class="text-lg text-black-600 mb-4">
            Blood is a specialized body fluid that consists of cells suspended in a liquid called plasma. It
            makes up
            approximately 7-8% of human body weight.
          </p>

          <div class="flex flex-col md:flex-row gap-6 mb-8">
            <div class="md:w-1/2 bg-black-50 p-4 rounded-lg shadow-sm">
              <h5 class="font-bold text-gray-700 mb-2">Primary Functions of Blood:</h5>
              <ul class="list-disc list-inside text-gray-600 space-y-2">
                <li>Transportation of oxygen from the lungs to all body tissues</li>
                <li>Delivery of nutrients from the digestive system to cells</li>
                <li>Removal of waste products to excretory organs</li>
                <li>Defense against infections through white blood cells</li>
                <li>Regulation of body temperature</li>
                <li>Maintenance of proper pH balance</li>
                <li>Prevention of blood loss through clotting</li>
              </ul>
            </div>
            <div class="md:w-1/2 bg-gray-50 p-4 rounded-lg shadow-sm">
              <h5 class="font-bold text-gray-700 mb-2">Blood Composition:</h5>
              <div class="relative h-40">
                <div class="absolute inset-0 rounded-lg overflow-hidden">
                  <div class="h-2/5 bg-yellow-100 w-full p-2 flex items-center">
                    <span class="text-sm font-medium">Plasma (55%)</span>
                  </div>
                  <div class="h-2/5 bg-red-400 w-full p-2 flex items-center">
                    <span class="text-sm font-medium text-white">Red Blood Cells (45%)</span>
                  </div>
                  <div class="h-1/5 flex w-full">
                    <div class="h-full bg-blue-300 w-4/5 p-1 flex items-center justify-center">
                      <span class="text-xs font-medium">White Blood Cells</span>
                    </div>
                    <div class="h-full bg-purple-300 w-1/5 p-1 flex items-center justify-center">
                      <span class="text-xs font-medium">Platelets</span>
                    </div>
                  </div>
                </div>
              </div>
              <p class="text-xs text-gray-500 mt-2 text-center">Visual representation of blood composition
              </p>
            </div>
          </div>

          <div class="bg-red-50 border-l-4 border-red-500 p-4 mb-6">
            <h5 class="text-2xl font-bold text-red-700 mb-1">Did You Know?</h5>
            <p class="text-lg text-black-700">
              The average adult has around 5-6 liters of blood in their body, which is replenished
              constantly. When
              you donate blood (450ml), your body replaces the fluid portion within 24 hours and the
              cellular
              components within a few weeks.
            </p>
          </div>
        </div>

        <!-- Blood Products Tab -->
        <div class="education-content p-6 hidden" id="blood-products-content">
          <h3 class="text-2xl font-bold text-gray-800 mb-6">Types of Blood Products</h3>

          <h4 class="text-xl font-bold text-gray-700 mb-2">Blood Types and Compatibility</h4>
          <p class="text-gray-600 mb-4">
            Blood types are determined by the presence or absence of certain antigens on the surface of red
            blood
            cells. The two main classification systems are ABO and Rh factor.
          </p>

          <div class="overflow-x-auto mb-8">
            <table class="min-w-full bg-white rounded-lg overflow-hidden">
              <thead class="bg-red-600 text-white">
                <tr>
                  <th class="py-3 px-4 text-left">Blood Type</th>
                  <th class="py-3 px-4 text-left">Can Donate To</th>
                  <th class="py-3 px-4 text-left">Can Receive From</th>
                  <th class="py-3 px-4 text-left">Population %</th>
                </tr>
              </thead>
              <tbody class="divide-y divide-gray-200">
                <tr class="hover:bg-gray-50">
                  <td class="py-3 px-4 font-medium">A+</td>
                  <td class="py-3 px-4">A+, AB+</td>
                  <td class="py-3 px-4">A+, A-, O+, O-</td>
                  <td class="py-3 px-4">~30%</td>
                </tr>
                <tr class="hover:bg-gray-50">
                  <td class="py-3 px-4 font-medium">A-</td>
                  <td class="py-3 px-4">A+, A-, AB+, AB-</td>
                  <td class="py-3 px-4">A-, O-</td>
                  <td class="py-3 px-4">~6%</td>
                </tr>
                <tr class="hover:bg-gray-50">
                  <td class="py-3 px-4 font-medium">B+</td>
                  <td class="py-3 px-4">B+, AB+</td>
                  <td class="py-3 px-4">B+, B-, O+, O-</td>
                  <td class="py-3 px-4">~8%</td>
                </tr>
                <tr class="hover:bg-gray-50">
                  <td class="py-3 px-4 font-medium">B-</td>
                  <td class="py-3 px-4">B+, B-, AB+, AB-</td>
                  <td class="py-3 px-4">B-, O-</td>
                  <td class="py-3 px-4">~2%</td>
                </tr>
                <tr class="hover:bg-gray-50">
                  <td class="py-3 px-4 font-medium">AB+</td>
                  <td class="py-3 px-4">AB+ (Universal recipient)</td>
                  <td class="py-3 px-4">All types</td>
                  <td class="py-3 px-4">~3%</td>
                </tr>
                <tr class="hover:bg-gray-50">
                  <td class="py-3 px-4 font-medium">AB-</td>
                  <td class="py-3 px-4">AB+, AB-</td>
                  <td class="py-3 px-4">A-, B-, AB-, O-</td>
                  <td class="py-3 px-4">~1%</td>
                </tr>
                <tr class="hover:bg-gray-50">
                  <td class="py-3 px-4 font-medium">O+</td>
                  <td class="py-3 px-4">A+, B+, AB+, O+</td>
                  <td class="py-3 px-4">O+, O-</td>
                  <td class="py-3 px-4">~38%</td>
                </tr>
                <tr class="hover:bg-gray-50">
                  <td class="py-3 px-4 font-medium">O-</td>
                  <td class="py-3 px-4">All types (Universal donor)</td>
                  <td class="py-3 px-4">O- only</td>
                  <td class="py-3 px-4">~7%</td>
                </tr>
              </tbody>
            </table>
          </div>

          <h4 class="text-xl font-bold text-gray-700 mb-2">Blood Components and Their Uses</h4>

          <div class="grid md:grid-cols-2 gap-6 mb-8">
            <div class="bg-white rounded-lg shadow-md overflow-hidden border border-gray-200">
              <div class="bg-red-600 text-white p-3">
                <h5 class="font-bold">Red Blood Cells (Erythrocytes)</h5>
              </div>
              <div class="p-4">
                <p class="text-gray-600 mb-3">
                  Disc-shaped cells containing hemoglobin that transport oxygen throughout the body.
                </p>
                <h6 class="font-bold text-gray-700 mb-1">Used for:</h6>
                <ul class="list-disc list-inside text-gray-600 mb-3">
                  <li>Severe anemia</li>
                  <li>Blood loss from surgery or injury</li>
                  <li>Chronic conditions like thalassemia</li>
                </ul>
                <h6 class="font-bold text-gray-700 mb-1">Storage Time:</h6>
                <p class="text-gray-600">Up to 42 days at 2-6°C</p>
              </div>
            </div>

            <div class="bg-white rounded-lg shadow-md overflow-hidden border border-gray-200">
              <div class="bg-yellow-400 text-white p-3">
                <h5 class="font-bold">Blood Plasma</h5>
              </div>
              <div class="p-4">
                <p class="text-gray-600 mb-3">
                  Yellowish liquid component of blood that contains proteins, clotting factors, and
                  other substances.
                </p>
                <h6 class="font-bold text-gray-700 mb-1">Used for:</h6>
                <ul class="list-disc list-inside text-gray-600 mb-3">
                  <li>Bleeding disorders</li>
                  <li>Burns and shock</li>
                  <li>Liver diseases</li>
                  <li>Immunodeficiencies</li>
                </ul>
                <h6 class="font-bold text-gray-700 mb-1">Storage Time:</h6>
                <p class="text-gray-600">Up to 1 year frozen at -18°C or below</p>
              </div>
            </div>

            <div class="bg-white rounded-lg shadow-md overflow-hidden border border-gray-200">
              <div class="bg-purple-500 text-white p-3">
                <h5 class="font-bold">Platelets (Thrombocytes)</h5>
              </div>
              <div class="p-4">
                <p class="text-gray-600 mb-3">
                  Tiny cell fragments that help blood to clot and prevent excessive bleeding.
                </p>
                <h6 class="font-bold text-gray-700 mb-1">Used for:</h6>
                <ul class="list-disc list-inside text-gray-600 mb-3">
                  <li>Cancer patients undergoing chemotherapy</li>
                  <li>Bone marrow transplant recipients</li>
                  <li>Bleeding disorders</li>
                  <li>Major surgeries or trauma</li>
                </ul>
                <h6 class="font-bold text-gray-700 mb-1">Storage Time:</h6>
                <p class="text-gray-600">Up to 5 days at room temperature with agitation</p>
              </div>
            </div>

            <div class="bg-white rounded-lg shadow-md overflow-hidden border border-gray-200">
              <div class="bg-blue-500 text-white p-3">
                <h5 class="font-bold">Cryoprecipitate</h5>
              </div>
              <div class="p-4">
                <p class="text-gray-600 mb-3">
                  Concentrated portion of plasma containing clotting factors like fibrinogen, Factor
                  VIII, and von
                  Willebrand factor.
                </p>
                <h6 class="font-bold text-gray-700 mb-1">Used for:</h6>
                <ul class="list-disc list-inside text-gray-600 mb-3">
                  <li>Hemophilia</li>
                  <li>Von Willebrand disease</li>
                  <li>Disseminated intravascular coagulation (DIC)</li>
                  <li>Massive bleeding with low fibrinogen</li>
                </ul>
                <h6 class="font-bold text-gray-700 mb-1">Storage Time:</h6>
                <p class="text-gray-600">Up to 1 year frozen at -18°C or below</p>
              </div>
            </div>
          </div>
        </div>

        <!-- Blood Needs Tab -->
        <div class="education-content p-6 hidden" id="blood-needs-content">
          <h3 class="text-2xl font-bold text-gray-800 mb-6">Blood Needs and Demand</h3>

          <div class="flex flex-col md:flex-row gap-8 mb-8">
            <div class="md:w-1/2">
              <h4 class="text-xl font-bold text-gray-700 mb-4">Why Is Blood Always Needed?</h4>
              <p class="text-gray-600 mb-4">
                Blood cannot be manufactured or synthesized — it can only come from generous donors.
                Even with medical
                advances, there is no substitute for human blood.
              </p>
              <p class="text-gray-600 mb-4">
                Every day, hospitals need fresh supplies of blood for routine surgeries, emergency
                situations, and
                ongoing treatments for chronic conditions.
              </p>
              <div class="bg-red-50 border-l-4 border-red-500 p-4 mb-6">
                <p class="text-gray-700 font-medium">
                  Every 2 seconds, someone needs blood — that's approximately 43,000 units needed
                  daily.
                </p>
              </div>
            </div>
            <div class="md:w-1/2">
              <img src="img/blood-donation.png" alt="Blood Donation Need" class="w-full h-auto rounded-lg shadow-md" />
            </div>
          </div>

          <h4 class="text-xl font-bold text-gray-700 mb-4">Who Needs Blood?</h4>

          <div class="grid md:grid-cols-3 gap-6 mb-8">
            <div class="bg-white rounded-lg shadow-md p-5 border-t-4 border-red-600">
              <div class="text-red-600 mb-3">
                <i class="fas fa-hospital-user text-3xl"></i>
              </div>
              <h5 class="font-bold text-gray-800 mb-2">Surgery and Trauma Patients</h5>
              <p class="text-gray-600">
                Patients undergoing major surgeries or experiencing traumatic injuries often require
                blood
                transfusions to replace lost blood and stabilize their condition.
              </p>
            </div>

            <div class="bg-white rounded-lg shadow-md p-5 border-t-4 border-red-600">
              <div class="text-red-600 mb-3">
                <i class="fas fa-baby text-3xl"></i>
              </div>
              <h5 class="font-bold text-gray-800 mb-2">Mothers and Newborns</h5>
              <p class="text-gray-600">
                Women experiencing complications during childbirth may need blood transfusions.
                Premature and ill
                newborns often need blood components.
              </p>
            </div>

            <div class="bg-white rounded-lg shadow-md p-5 border-t-4 border-red-600">
              <div class="text-red-600 mb-3">
                <i class="fas fa-heartbeat text-3xl"></i>
              </div>
              <h5 class="font-bold text-gray-800 mb-2">Cancer Patients</h5>
              <p class="text-gray-600">
                Many cancer treatments affect the body's ability to produce blood cells. Transfusions
                help patients
                maintain strength during chemotherapy and radiation.
              </p>
            </div>

            <div class="bg-white rounded-lg shadow-md p-5 border-t-4 border-red-600">
              <div class="text-red-600 mb-3">
                <i class="fas fa-procedures text-3xl"></i>
              </div>
              <h5 class="font-bold text-gray-800 mb-2">Chronic Disease Patients</h5>
              <p class="text-gray-600">
                People with sickle cell disease, thalassemia, and hemophilia require regular blood
                transfusions
                throughout their lives.
              </p>
            </div>

            <div class="bg-white rounded-lg shadow-md p-5 border-t-4 border-red-600">
              <div class="text-red-600 mb-3">
                <i class="fas fa-car-crash text-3xl"></i>
              </div>
              <h5 class="font-bold text-gray-800 mb-2">Accident Victims</h5>
              <p class="text-gray-600">
                A single car accident victim can require up to 100 units of blood. Emergency responders
                need immediate
                access to blood to save lives.
              </p>
            </div>

            <div class="bg-white rounded-lg shadow-md p-5 border-t-4 border-red-600">
              <div class="text-red-600 mb-3">
                <i class="fas fa-fire text-3xl"></i>
              </div>
              <h5 class="font-bold text-gray-800 mb-2">Burn Victims</h5>
              <p class="text-gray-600">
                People with severe burns often need plasma transfusions to replace lost fluids and help
                maintain blood
                pressure.
              </p>
            </div>
          </div>

          <h4 class="text-xl font-bold text-gray-700 mb-4">Blood Usage Statistics</h4>

          <div class="bg-white rounded-lg shadow-md overflow-hidden mb-8">
            <div class="p-6">
              <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                <div class="bg-gray-50 p-4 rounded-lg text-center">
                  <span class="block text-3xl font-bold text-red-600 mb-2">36,000</span>
                  <span class="text-sm text-gray-600">Units of red blood cells needed daily</span>
                </div>
                <div class="bg-gray-50 p-4 rounded-lg text-center">
                  <span class="block text-3xl font-bold text-red-600 mb-2">7,000</span>
                  <span class="text-sm text-gray-600">Units of platelets needed daily</span>
                </div>
                <div class="bg-gray-50 p-4 rounded-lg text-center">
                  <span class="block text-3xl font-bold text-red-600 mb-2">10,000</span>
                  <span class="text-sm text-gray-600">Units of plasma needed daily</span>
                </div>
                <div class="bg-gray-50 p-4 rounded-lg text-center">
                  <span class="block text-3xl font-bold text-red-600 mb-2">3</span>
                  <span class="text-sm text-gray-600">Lives saved by one donation</span>
                </div>
              </div>

              <h5 class="font-bold text-gray-700 mb-2">Blood Usage by Condition:</h5>
              <div class="space-y-3">
                <div>
                  <div class="flex justify-between mb-1">
                    <span class="text-sm font-medium text-gray-700">Cancer Treatment</span>
                    <span class="text-sm font-medium text-gray-700">25%</span>
                  </div>
                  <div class="w-full bg-gray-200 rounded-full h-2">
                    <div class="bg-red-600 h-2 rounded-full" style="width: 25%"></div>
                  </div>
                </div>
                <div>
                  <div class="flex justify-between mb-1">
                    <span class="text-sm font-medium text-gray-700">Surgery & Trauma</span>
                    <span class="text-sm font-medium text-gray-700">35%</span>
                  </div>
                  <div class="w-full bg-gray-200 rounded-full h-2">
                    <div class="bg-red-600 h-2 rounded-full" style="width: 35%"></div>
                  </div>
                </div>
                <div>
                  <div class="flex justify-between mb-1">
                    <span class="text-sm font-medium text-gray-700">Blood Disorders</span>
                    <span class="text-sm font-medium text-gray-700">15%</span>
                  </div>
                  <div class="w-full bg-gray-200 rounded-full h-2">
                    <div class="bg-red-600 h-2 rounded-full" style="width: 15%"></div>
                  </div>
                </div>
                <div>
                  <div class="flex justify-between mb-1">
                    <span class="text-sm font-medium text-gray-700">Heart & Burn Procedures</span>
                    <span class="text-sm font-medium text-gray-700">12%</span>
                  </div>
                  <div class="w-full bg-gray-200 rounded-full h-2">
                    <div class="bg-red-600 h-2 rounded-full" style="width: 12%"></div>
                  </div>
                </div>
                <div>
                  <div class="flex justify-between mb-1">
                    <span class="text-sm font-medium text-gray-700">Other Medical Conditions</span>
                    <span class="text-sm font-medium text-gray-700">13%</span>
                  </div>
                  <div class="w-full bg-gray-200 rounded-full h-2">
                    <div class="bg-red-600 h-2 rounded-full" style="width: 13%"></div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </section>
  <!-- Blood Availability Section -->
  <section class="py-10 px-4 bg-red-50" id="blood-stock">
    <div class="container mx-auto">
      <h2 class="text-3xl font-bold text-center text-gray-800 mb-8">Blood Stock Availability</h2>
      <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
        <!-- Blood Type A+ -->
        <div class="bg-white rounded-xl shadow-md p-4 flex flex-col items-center">
          <div class="w-16 h-16 rounded-full bg-red-100 flex items-center justify-center mb-2">
            <span class="text-red-600 text-2xl font-bold">A+</span>
          </div>
          <span class="text-lg font-semibold">85 Units</span>
          <div class="w-full bg-gray-200 rounded-full h-2.5 mt-2">
            <div class="bg-red-600 h-2.5 rounded-full" style="width: 85%"></div>
          </div>
          <span class="text-sm text-gray-500 mt-2">Status: Available</span>
        </div>
        <!-- Blood Type B+ -->
        <div class="bg-white rounded-xl shadow-md p-4 flex flex-col items-center">
          <div class="w-16 h-16 rounded-full bg-red-100 flex items-center justify-center mb-2">
            <span class="text-red-600 text-2xl font-bold">B+</span>
          </div>
          <span class="text-lg font-semibold">43 Units</span>
          <div class="w-full bg-gray-200 rounded-full h-2.5 mt-2">
            <div class="bg-yellow-500 h-2.5 rounded-full" style="width: 43%"></div>
          </div>
          <span class="text-sm text-yellow-500 mt-2">Status: Low</span>
        </div>
        <!-- Blood Type AB+ -->
        <div class="bg-white rounded-xl shadow-md p-4 flex flex-col items-center">
          <div class="w-16 h-16 rounded-full bg-red-100 flex items-center justify-center mb-2">
            <span class="text-red-600 text-2xl font-bold">AB+</span>
          </div>
          <span class="text-lg font-semibold">25 Units</span>
          <div class="w-full bg-gray-200 rounded-full h-2.5 mt-2">
            <div class="bg-red-500 h-2.5 rounded-full" style="width: 25%"></div>
          </div>
          <span class="text-sm text-red-500 mt-2">Status: Critical</span>
        </div>
        <!-- Blood Type O+ -->
        <div class="bg-white rounded-xl shadow-md p-4 flex flex-col items-center">
          <div class="w-16 h-16 rounded-full bg-red-100 flex items-center justify-center mb-2">
            <span class="text-red-600 text-2xl font-bold">O+</span>
          </div>
          <span class="text-lg font-semibold">60 Units</span>
          <div class="w-full bg-gray-200 rounded-full h-2.5 mt-2">
            <div class="bg-yellow-500 h-2.5 rounded-full" style="width: 60%"></div>
          </div>
          <span class="text-sm text-yellow-500 mt-2">Status: Low</span>
        </div>
        <!-- Blood Type A- -->
        <div class="bg-white rounded-xl shadow-md p-4 flex flex-col items-center">
          <div class="w-16 h-16 rounded-full bg-red-100 flex items-center justify-center mb-2">
            <span class="text-red-600 text-2xl font-bold">A-</span>
          </div>
          <span class="text-lg font-semibold">18 Units</span>
          <div class="w-full bg-gray-200 rounded-full h-2.5 mt-2">
            <div class="bg-red-500 h-2.5 rounded-full" style="width: 18%"></div>
          </div>
          <span class="text-sm text-red-500 mt-2">Status: Critical</span>
        </div>
        <!-- Blood Type B- -->
        <div class="bg-white rounded-xl shadow-md p-4 flex flex-col items-center">
          <div class="w-16 h-16 rounded-full bg-red-100 flex items-center justify-center mb-2">
            <span class="text-red-600 text-2xl font-bold">B-</span>
          </div>
          <span class="text-lg font-semibold">12 Units</span>
          <div class="w-full bg-gray-200 rounded-full h-2.5 mt-2">
            <div class="bg-red-500 h-2.5 rounded-full" style="width: 12%"></div>
          </div>
          <span class="text-sm text-red-500 mt-2">Status: Critical</span>
        </div>
        <!-- Blood Type AB- -->
        <div class="bg-white rounded-xl shadow-md p-4 flex flex-col items-center">
          <div class="w-16 h-16 rounded-full bg-red-100 flex items-center justify-center mb-2">
            <span class="text-red-600 text-2xl font-bold">AB-</span>
          </div>
          <span class="text-lg font-semibold">7 Units</span>
          <div class="w-full bg-gray-200 rounded-full h-2.5 mt-2">
            <div class="bg-red-600 h-2.5 rounded-full" style="width: 7%"></div>
          </div>
          <span class="text-sm text-red-500 mt-2">Status: Critical</span>
        </div>
        <!-- Blood Type O- -->
        <div class="bg-white rounded-xl shadow-md p-4 flex flex-col items-center">
          <div class="w-16 h-16 rounded-full bg-red-100 flex items-center justify-center mb-2">
            <span class="text-red-600 text-2xl font-bold">O-</span>
          </div>
          <span class="text-lg font-semibold">32 Units</span>
          <div class="w-full bg-gray-200 rounded-full h-2.5 mt-2">
            <div class="bg-yellow-500 h-2.5 rounded-full" style="width: 32%"></div>
          </div>
          <span class="text-sm text-yellow-500 mt-2">Status: Low</span>
        </div>
      </div>
    </div>
    <div class="text-center mt-13 mb-12">
      <a href="donasi.html"
        class="bg-red-600 text-white py-4 px-8 rounded-lg shadow-lg hover:bg-red-700 transition duration-300 font-bold text-lg">
        Donate Now
      </a>
    </div>
  </section>

  <!-- How to Play Popup -->
  <div id="howToPlayPopup" class="popup-overlay hidden">
    <div class="popup-container">
      <button class="close-btn" onclick="closePopup()">&times;</button>

      <div class="popup-header">
        <h2 class="popup-title">🩸How To Play</h2>
        <p class="popup-subtitle">Collect blood, avoid bacteria!</p>
      </div>

      <div class="game-elements">
        <div class="element blood-element">
          <div class="element-icon">
            <img src="img/darahMerah.png" alt="Blood Cell" style="width: 50px; height: 50px; border-radius: 50%;">
          </div>
          <h3 class="element-title">Red Blood Cells</h3>
          <p class="element-desc">Click to collect and proceed to the next stage</p>
        </div>

        <div class="element bacteria-element">
          <div class="element-icon">
            <img src="img/bakteri.png" alt="Bacteria" style="width: 50px; height: 50px; border-radius: 50%;">
          </div>
          <h3 class="element-title">Bacteria</h3>
          <p class="element-desc">Avoid! Will make you game over</p>
        </div>
      </div>

      <div class="instructions">
        <h3 class="instruction-title">📋 Game Instructions</h3>
        <ul class="instruction-list">
          <li class="instruction-item">
            <span class="instruction-number">1</span>
            Click on red blood cells (🩸) to collect blood
          </li>
          <li class="instruction-item">
            <span class="instruction-number">2</span>
            Avoid green bacteria (🦠) to avoid game over
          </li>
          <li class="instruction-item">
            <span class="instruction-number">3</span>
            Pantau kantong darah di kanan atas untuk melihat progress
          </li>
          <li class="instruction-item">
            <span class="instruction-number">4</span>
            collect it then it will proceed to the next stage
          </li>
        </ul>
      </div>

      <div class="popup-buttons">
        <button class="btn-popup btn-play" onclick="startGame()">🎮 Games Start</button>
        <button class="btn-popup btn-close" onclick="closePopup()">❌ Close</button>
      </div>
    </div>
  </div>

  <div id="bacteria-notification-overlay" class="bacteria-notification-overlay" style="display: none;"></div>

  <!-- Pop-up notification -->
  <div id="bacteria-notification" class="bacteria-notification" style="display: none;">
    <h3>
      <span class="bacteria-icon">🦠</span>
      Bacteria Detected!
    </h3>
    <p> You accidentally clicked on bacteria! This contaminates the blood sample and makes it unsafe for donation.</p>
    <div class="remember-highlight">
      <strong>
        <span class="warning-icon">⚠️</span>
        Remember:
      </strong>
      Always avoid bacteria and only collect clean red blood cells.
    </div>
    <button onclick="closeBacteriaNotification()">Try Again</button>
  </div>

  <footer class="bg-gray-800 text-white py-12 px-4">
    <div class="container mx-auto">
      <div class="grid md:grid-cols-3 gap-8">
        <div>
          <h3 class="text-xl font-bold mb-4">About PMI Blood Heroes</h3>
          <p class="text-gray-300">
            An interactive educational platform that aims to raise awareness about the importance of blood
            donation among teenagers, especially middle and high school students.
          </p>
        </div>
        <div>
          <h3 class="text-xl font-bold mb-4">Important Links</h3>
          <ul class="space-y-2 text-gray-300">
            <li><a href="#" class="hover:text-red-400 transition duration-300">Blood Donation Locations</a></li>
            <li><a href="#" class="hover:text-red-400 transition duration-300">Mobile Unit Schedule</a></li>
            <li><a href="#" class="hover:text-red-400 transition duration-300">Blood Donation FAQ</a></li>
            <li><a href="#" class="hover:text-red-400 transition duration-300">Blood Donation Requirements</a></li>
            <li><a href="#" class="hover:text-red-400 transition duration-300">Contact PMI</a></li>
          </ul>
        </div>
        <div>
          <h3 class="text-xl font-bold mb-4">Contact Us</h3>
          <ul class="space-y-2 text-gray-300">
            <li>
              <a href="#" class="hover:text-red-400 transition duration-300">
                <i class="far fa-envelope mr-2"></i> Email: info@pmibloodheroes.id
              </a>
            </li>
            <li>
              <a href="#" class="hover:text-red-400 transition duration-300">
                <i class="fas fa-phone mr-2"></i> Phone: 021-7992325
              </a>
            </li>
            <li>
              <a href="#" class="hover:text-red-400 transition duration-300">
                <i class="fab fa-instagram mr-2"></i> Instagram: @pmibloodheroes
              </a>
            </li>
            <li>
              <a href="#" class="hover:text-red-400 transition duration-300">
                <i class="fab fa-facebook mr-2"></i> Facebook: PMI Blood Heroes
              </a>
            </li>
            <li>
              <a href="#" class="hover:text-red-400 transition duration-300">
                <i class="fab fa-twitter mr-2"></i> Twitter: @PMIBloodHeroes
              </a>
            </li>
          </ul>
        </div>
      </div>
      <div class="border-t border-gray-700 mt-8 pt-8 text-center text-gray-400">
        <p>&copy; 2025 PMI Blood Heroes. All rights reserved.</p>
      </div>
    </div>
  </footer>
  <script>
    // Mobile menu toggle
    const mobileMenuButton = document.getElementById('mobile-menu-button');
    const mobileMenu = document.getElementById('mobile-menu');

    if (mobileMenuButton && mobileMenu) {
      mobileMenuButton.addEventListener('click', function () {
        mobileMenu.classList.toggle('hidden');
      });
    }

    document.getElementById("sim-tab").classList.add("bg-gray-200");
    document.getElementById("quiz-tab").classList.remove("bg-gray-200");

    // Make simulation visible and quiz hidden
    document.getElementById("simulation").classList.remove("hidden");
    document.getElementById("quiz").classList.add("hidden");

    // Game tabs functionality - keep your existing event listeners
    document.getElementById("sim-tab").addEventListener("click", function () {
      console.log('🎯 Switching to simulation tab...');

      // Hide quiz
      const quizElement = document.getElementById("quiz");
      quizElement.style.removeProperty('display');
      quizElement.classList.add("hidden");

      // Show simulation
      const simulationElement = document.getElementById("simulation");
      simulationElement.classList.remove("hidden");
      simulationElement.style.display = 'block';

      // Update tab appearance
      this.classList.add("bg-gray-200");
      document.getElementById("quiz-tab").classList.remove("bg-gray-200");
    });

    document.getElementById("quiz-tab").addEventListener("click", function () {
      console.log('🎯 Switching to quiz tab...');

      // Hide simulation
      const simulationElement = document.getElementById("simulation");
      simulationElement.style.removeProperty('display');
      simulationElement.classList.add("hidden");

      // Show quiz
      const quizElement = document.getElementById("quiz");
      quizElement.classList.remove("hidden");
      quizElement.style.display = 'block';

      // Update tab appearance
      this.classList.add("bg-gray-200");
      document.getElementById("sim-tab").classList.remove("bg-gray-200");
    });

    // Quiz functionality
    document.addEventListener("DOMContentLoaded", function () {
      // Quiz questions
      const questions = {
        easy: [
          {
            question: "How long does it take for the body to replace plasma after donating blood?",
            options: ["12 hours", "24 hours", "36 hours", "48 hours"],
            correctAnswer: 1, // 24 hours
            explanation: "It typically takes about 24 hours for the body to replace plasma after a donation."
          },
          {
            question: "How many lives can one blood donation potentially save?",
            options: ["1 life", "Up to 3 lives", "Up to 5 lives", "Up to 10 lives"],
            correctAnswer: 1, // Up to 3 lives
            explanation: "One unit of blood can be separated into red cells, plasma, and platelets, potentially saving up to 3 lives."
          },
          {
            question: "What is the most common blood type in Indonesia?",
            options: ["A+", "B+", "AB+", "O+"],
            correctAnswer: 3, // O+
            explanation: "O+ is the most common blood type in Indonesia, present in about 35-40% of the population."
          },
          {
            question: "How often can a healthy person donate blood?",
            options: ["Every week", "Every month", "Every 2-3 months", "Every 6 months"],
            correctAnswer: 2, // Every 2-3 months
            explanation: "A healthy person can typically donate whole blood every 2-3 months (8-12 weeks)."
          },
          {
            question: "What is the minimum age to donate blood in most countries?",
            options: ["16 years", "17 years", "18 years", "21 years"],
            correctAnswer: 1, // 17 years
            explanation: "In most countries, the minimum age to donate blood is 17 years, though some may allow 16-year-olds with parental consent."
          }
        ],


        medium: [
          {
            question: "Which blood type is known as the universal donor?",
            options: ["A+", "B-", "AB+", "O-"],
            correctAnswer: 3, // O-
            explanation: "O- is the universal donor because it can be given to any blood type recipient without causing a negative reaction."
          },
          {
            question: "Which blood type is known as the universal recipient?",
            options: ["A+", "B+", "AB+", "O-"],
            correctAnswer: 2, // AB+
            explanation: "AB+ is the universal recipient because people with this blood type can receive blood from any blood type."
          },
          {
            question: "What percentage of the whole blood volume is made up of red blood cells?",
            options: ["About 20%", "About 45%", "About 65%", "About 80%"],
            correctAnswer: 1, // About 45%
            explanation: "Red blood cells make up approximately 45% of the total blood volume, a measurement known as hematocrit."
          },
          {
            question: "What is the average amount of blood in an adult human body?",
            options: ["3-4 liters", "5-6 liters", "8-10 liters", "12-15 liters"],
            correctAnswer: 1, // 5-6 liters
            explanation: "The average adult has about 5-6 liters of blood in their body, which is about 7-8% of body weight."
          },
          {
            question: "How long can red blood cells be stored before they must be used?",
            options: ["Up to 24 hours", "Up to 1 week", "Up to 42 days", "Up to 1 year"],
            correctAnswer: 2, // Up to 42 days
            explanation: "Red blood cells can be stored for up to 42 days (6 weeks) when kept at the proper temperature."
          }
        ],

        hard: [
          {
            question: "In which of the following conditions is someone NOT eligible to donate blood?",
            options: ["Recent tattoo within the last 3 months", "Well-controlled hypertension", "Past cancer diagnosis with 5+ years in remission", "Taking antibiotics for acne"],
            correctAnswer: 0, // Recent tattoo
            explanation: "A recent tattoo usually makes someone ineligible to donate blood for 3-6 months, due to the risk of bloodborne infections."
          },
          {
            question: "Which of the following blood components has the shortest shelf life when stored properly?",
            options: ["Red blood cells", "Plasma", "Platelets", "Cryoprecipitate"],
            correctAnswer: 2, // Platelets
            explanation: "Platelets have the shortest shelf life of 5-7 days when stored at room temperature with agitation."
          },
          {
            question: "What inherited blood disorder affects the hemoglobin in red blood cells, causing them to form a sickle or crescent shape?",
            options: ["Hemophilia", "Von Willebrand disease", "Sickle cell anemia", "Thalassemia"],
            correctAnswer: 2, // Sickle cell anemia
            explanation: "Sickle cell anemia is a genetic disorder where abnormal hemoglobin causes red blood cells to become sickle-shaped, causing various health complications."
          },
          {
            question: "Which of the following is NOT a blood group system used in transfusion medicine?",
            options: ["ABO system", "Rh system", "MN system", "Duffy system"],
            correctAnswer: 2, // MN system
            explanation: "While the MN system exists, it's not commonly used in routine transfusion medicine like ABO, Rh, and Duffy systems are."
          },
          {
            question: "What is the process called where blood is separated into its components?",
            options: ["Dialysis", "Fractionation", "Centrifugation", "Apheresis"],
            correctAnswer: 2, // Centrifugation
            explanation: "Centrifugation is the process where donated blood is spun at high speeds to separate it into its components, like red cells, plasma, and platelets."
          }
        ]
      };

      // Game settings
      const gameSettings = {
        questionsPerGame: {
          easy: 3,
          medium: 2,
          hard: 1
        },
        pointsPerDifficulty: {
          easy: 10,
          medium: 20,
          hard: 30
        },
        totalPointsPossible: 100 // Total points in a round
      };

      // Generate random quiz questions based on difficulty settings
      function generateQuizQuestions() {
        let quizQuestions = [];

        // Add questions for each difficulty level
        Object.entries(gameSettings.questionsPerGame).forEach(([difficulty, count]) => {
          // Get all questions for current difficulty
          const availableQuestions = questions[difficulty];

          // Create a copy to shuffle
          const shuffled = [...availableQuestions].sort(() => 0.5 - Math.random());

          // Add the required number of questions with their difficulty
          shuffled.slice(0, count).forEach(question => {
            quizQuestions.push({
              ...question,
              difficulty: difficulty,
              points: gameSettings.pointsPerDifficulty[difficulty]
            });
          });
        });

        // Shuffle all questions to mix difficulties
        return quizQuestions.sort(() => 0.5 - Math.random());
      }


      // Quiz variables
      let currentQuestions = []; // Will hold the selected questions for this game
      let currentQuestion = 0
      let score = 0
      let selectedOption = null
      let userPoints = 304 // Initial points from the original HTML

      // Quiz elements
      const quizIntro = document.getElementById("quiz-intro")
      const quizContainer = document.getElementById("quiz-container")
      const quizResults = document.getElementById("quiz-results")
      const startQuizBtn = document.getElementById("start-quiz")
      const submitAnswerBtn = document.getElementById("submit-answer")
      const nextQuestionBtn = document.getElementById("next-question")
      const retryQuizBtn = document.getElementById("retry-quiz")
      const backToHomeBtn = document.getElementById("back-to-home")
      const questionText = document.getElementById("question-text")
      const optionsContainer = document.getElementById("options-container")
      const currentQuestionEl = document.getElementById("current-question")
      const totalQuestionsEl = document.getElementById("total-questions")
      const quizProgress = document.getElementById("quiz-progress")
      const quizScore = document.getElementById("quiz-score")
      const finalScore = document.getElementById("final-score")
      const resultMessage = document.getElementById("result-message")
      const pointsEarned = document.getElementById("points-earned")
      const pointsValue = document.getElementById("points-value")
      const feedbackAlert = document.getElementById("feedback-alert")
      const feedbackText = document.getElementById("feedback-text")
      const feedbackExplanation = document.getElementById("feedback-explanation")
      const pointsDisplay = document.querySelector(".quiz-points")

      // Set total questions
      const totalQuestions = Object.values(gameSettings.questionsPerGame).reduce((a, b) => a + b, 0);
      totalQuestionsEl.textContent = totalQuestions;

      // Start quiz
      startQuizBtn.addEventListener("click", function () {
        quizIntro.classList.add("hidden");
        quizContainer.classList.remove("hidden");

        // Generate quiz questions
        currentQuestions = generateQuizQuestions();
        currentQuestion = 0;
        score = 0;
        quizScore.textContent = "0";

        loadQuestion();
      });

      // Load question
      function loadQuestion() {
        // Update question counter
        currentQuestionEl.textContent = currentQuestion + 1;

        // Update progress bar
        const progressPercentage = ((currentQuestion + 1) / totalQuestions) * 100;
        quizProgress.style.width = `${progressPercentage}%`;

        // Reset selected option
        selectedOption = null;

        // Get current question
        const questionData = currentQuestions[currentQuestion];

        // Load question text
        questionText.textContent = questionData.question;

        // Add difficulty badge if it doesn't exist yet
        if (!document.getElementById('difficulty-badge')) {
          const badge = document.createElement('span');
          badge.id = 'difficulty-badge';
          badge.className = 'ml-2 px-2 py-1 text-xs font-bold rounded-full text-white';
          questionText.parentNode.appendChild(badge);
        }

        // Add points display if it doesn't exist yet
        if (!document.getElementById('points-container')) {
          const pointsContainer = document.createElement('div');
          pointsContainer.id = 'points-container';
          pointsContainer.className = 'bg-gray-50 rounded-lg p-3 mb-4 flex items-center border border-gray-200';
          pointsContainer.innerHTML = `
      <div class="bg-red-50 rounded-full p-2 mr-3">
        <i class="fas fa-coins text-red-500"></i>
      </div>
      <span class="text-gray-700">Points for correct answer: <span id="points-value" class="font-bold">10</span></span>
    `;
          questionText.parentNode.parentNode.insertBefore(pointsContainer, document.getElementById('options-container').parentNode);
        }

        // Set difficulty badge
        const difficultyBadge = document.getElementById('difficulty-badge');
        difficultyBadge.textContent = questionData.difficulty.charAt(0).toUpperCase() + questionData.difficulty.slice(1);

        // Set difficulty badge color
        difficultyBadge.className = 'ml-2 px-2 py-1 text-xs font-bold rounded-full text-white';
        if (questionData.difficulty === 'easy') {
          difficultyBadge.classList.add('bg-green-600');
        } else if (questionData.difficulty === 'medium') {
          difficultyBadge.classList.add('bg-yellow-600');
        } else {
          difficultyBadge.classList.add('bg-red-600');
        }

        // Display points value for this question
        const pointsValue = document.getElementById('points-value');
        if (pointsValue) {
          pointsValue.textContent = questionData.points;
        }

        // Load options
        optionsContainer.innerHTML = '';
        questionData.options.forEach((option, index) => {
          const optionDiv = document.createElement('div');
          optionDiv.className = 'p-4 bg-gray-100 rounded-lg hover:bg-gray-200 cursor-pointer transition duration-300';
          optionDiv.dataset.index = index;
          optionDiv.innerHTML = `<span class="font-medium">${String.fromCharCode(65 + index)}.</span> ${option}`;

          // Add click event to select option
          optionDiv.addEventListener('click', function () {
            // Remove selected class from all options
            document.querySelectorAll('#options-container div').forEach((div) => {
              div.classList.remove('bg-red-100', 'border-2', 'border-red-600');
            });

            // Add selected class to clicked option
            this.classList.add('bg-red-100', 'border-2', 'border-red-600');

            // Update selected option
            selectedOption = parseInt(this.dataset.index);
          });

          optionsContainer.appendChild(optionDiv);
        });

        // Hide next button, show submit button
        submitAnswerBtn.classList.remove('hidden');
        nextQuestionBtn.classList.add('hidden');

        // Hide feedback
        feedbackAlert.classList.add('hidden');
      }

      // Submit answer
      submitAnswerBtn.addEventListener('click', function () {
        if (selectedOption === null) {
          alert('Please select an answer');
          return;
        }

        // Change this line from currentQuestionIndex to currentQuestion
        const currentQuestionData = currentQuestions[currentQuestion];
        const correctAnswer = currentQuestionData.correctAnswer;
        const questionPoints = currentQuestionData.points;

        // Check if answer is correct
        if (selectedOption === correctAnswer) {
          score += questionPoints;
          quizScore.textContent = score;

          // Show correct feedback
          feedbackAlert.className = 'mt-4 p-4 rounded-lg bg-green-100 text-green-800';
          feedbackText.textContent = `Correct! (+${questionPoints} points)`;
          feedbackExplanation.textContent = currentQuestionData.explanation;
        } else {
          // Show incorrect feedback
          feedbackAlert.className = 'mt-4 p-4 rounded-lg bg-red-100 text-red-800';
          feedbackText.textContent = 'Incorrect!';
          feedbackExplanation.textContent = `The correct answer is: ${currentQuestionData.options[correctAnswer]}. ${currentQuestionData.explanation}`;

          // Highlight correct answer
          document.querySelectorAll('#options-container div').forEach((div, index) => {
            if (index === correctAnswer) {
              div.classList.remove('bg-red-100', 'border-red-600');
              div.classList.add('bg-green-100', 'border-2', 'border-green-600');
            }
          });
        }

        feedbackAlert.classList.remove('hidden');

        // Hide submit button, show next button or finish quiz
        submitAnswerBtn.classList.add('hidden');

        // Change this line from currentQuestionIndex to currentQuestion
        if (currentQuestion < currentQuestions.length - 1) {
          nextQuestionBtn.classList.remove('hidden');
        } else {
          // Show results after a short delay
          setTimeout(showResults, 1500);
        }
      });

      // Next question
      nextQuestionBtn.addEventListener("click", function () {
        currentQuestion++
        loadQuestion()
      })

      // Show results
      function showResults() {
        quizContainer.classList.add('hidden');
        quizResults.classList.remove('hidden');

        finalScore.textContent = score;
        const maxScore = gameSettings.totalPointsPossible;

        // Set result message based on score
        if (score >= maxScore * 0.8) {
          resultMessage.textContent = 'Excellent! You\'re a blood donation expert!';
          document.getElementById('success-icon').innerHTML = '<i class="fas fa-trophy text-6xl text-yellow-500"></i>';
        } else if (score >= maxScore * 0.6) {
          resultMessage.textContent = 'Good job! You know quite a bit about blood donation.';
          document.getElementById('success-icon').innerHTML = '<i class="fas fa-medal text-6xl text-blue-500"></i>';
        } else if (score >= maxScore * 0.4) {
          resultMessage.textContent = 'Not bad, but there\'s room for improvement.';
          document.getElementById('success-icon').innerHTML = '<i class="fas fa-thumbs-up text-6xl text-green-500"></i>';
        } else {
          resultMessage.textContent = 'Keep learning! Check out our education section for more information.';
          document.getElementById('success-icon').innerHTML = '<i class="fas fa-book text-6xl text-red-500"></i>';
        }

        // Set earned points
        if (score > 0) {
          pointsValue.textContent = score;
          pointsEarned.classList.remove('hidden');

          // Update profile points
          userPoints += score;
          const pointsDisplays = document.querySelectorAll('.points-display, .font-medium.text-sm.ml-3');
          pointsDisplays.forEach(display => {
            if (display) {
              display.textContent = `${userPoints} Points`;
            }
          });
        } else {
          pointsEarned.classList.add('hidden');
        }
      }

      // Retry quiz
      retryQuizBtn.addEventListener("click", function () {
        // Reset quiz variables
        currentQuestion = 0
        score = 0
        quizScore.textContent = 0

        // Show quiz container, hide results
        quizResults.classList.add("hidden")
        quizContainer.classList.remove("hidden")

        // Load first question
        loadQuestion()
      })

      // Back to home
      backToHomeBtn.addEventListener("click", function () {
        // Reset quiz variables
        currentQuestion = 0
        score = 0
        quizScore.textContent = 0

        // Show intro, hide results
        quizResults.classList.add("hidden")
        quizIntro.classList.remove("hidden")
      })
    })

    // Wait for the DOM to be fully loaded before executing
    document.addEventListener("DOMContentLoaded", function () {
      // Get all tab buttons
      const tabButtons = document.querySelectorAll(".education-tab")

      // Get all content sections
      const contentSections = document.querySelectorAll(".education-content")

      // Function to handle tab switching
      function switchTab(tabId) {
        // Hide all content sections
        contentSections.forEach((section) => {
          section.classList.add("hidden")
        })

        // Remove active state from all tab buttons
        tabButtons.forEach((button) => {
          button.classList.remove("bg-gray-200")
          button.classList.add("hover:bg-gray-200")
        })

        // Show the selected content section
        const selectedContent = document.getElementById(`${tabId}-content`)
        if (selectedContent) {
          selectedContent.classList.remove("hidden")
        }

        // Set active state for the clicked tab button
        const activeButton = document.querySelector(`[data-tab="${tabId}"]`)
        if (activeButton) {
          activeButton.classList.add("bg-gray-200")
          activeButton.classList.remove("hover:bg-gray-200")
        }
      }

      // Add click event listeners to all tab buttons
      tabButtons.forEach((button) => {
        button.addEventListener("click", function () {
          const tabId = this.getAttribute("data-tab")
          switchTab(tabId)
        })
      })

      // Set the default active tab (first tab)
      const defaultTabId = tabButtons[0].getAttribute("data-tab")
      switchTab(defaultTabId)
    })

    // Profile dropdown functionality
    const profileButton = document.getElementById('profileButton');
    const dropdownMenu = document.getElementById('dropdownMenu');

    if (profileButton && dropdownMenu) {
      profileButton.addEventListener('click', function (e) {
        e.stopPropagation();
        dropdownMenu.classList.toggle('show');
      });

      // Close dropdown when clicking outside
      document.addEventListener('click', function (e) {
        if (!profileButton.contains(e.target) && !dropdownMenu.contains(e.target)) {
          dropdownMenu.classList.remove('show');
        }
      });
    }

    // Initialize the hero slider
    $(document).ready(function () {
      $('.hero-slider').slick({
        dots: true,
        infinite: true,
        speed: 800,
        fade: true,
        cssEase: 'linear',
        autoplay: true,
        autoplaySpeed: 5000,
        arrows: true,
        adaptiveHeight: false
      });
    });


    let selectedItem = null;
    let currentStage = 'donor';
    let gameState = {
      armCleaned: false,
      bloodCollected: false,
      testDone: false,
      bandageApplied: false,
      bloodGroupTested: false,
      bloodGroupIdentified: false,
      bloodDelivered: false, // Tambahan untuk Blood Run
      transfusionComplete: false,
      donorBloodType: 'A+', // Default blood type for donor
      recipientBloodType: 'A+', // Default blood type for recipient
      selectedGroupABO: '', // Untuk menyimpan pilihan golongan ABO
      selectedGroupRh: '', // Untuk menyimpan pilihan rhesus
    };

    // Tap game state
    let tapGameState = {
      active: false,
      canvas: null,
      ctx: null,
      score: 0,
      progress: 0,
      maxProgress: 100,
      gameTime: 0,
      spawnTimer: 0,
      circles: [],
      maxCircles: 3,
      radius: 50
    };

    // Tap game images
    const tapBloodImage = new Image();
    const tapBacteriaImage = new Image();
    tapBloodImage.src = 'img/darahMerah.png';
    tapBacteriaImage.src = 'img/bakteri.png';

    let bloodRunGame = {
      active: false,
      completed: false,
      canvas: null,
      ctx: null,
      animationId: null
    };

    // Blood Run Game State
    let brGameState = {
      boardWidth: 700,
      boardHeight: 220,
      dinosaurWidth: 88,
      dinosaurHeight: 94,
      dinosaurX: 50,
      dinosaurY: 0,

      cactus1Width: 100,
      cactus2Width: 95,
      truckWidth: 100, // Dimensi truck (biasanya lebih besar)
      truckHeight: 70,
      cactusHeight: 70,
      cactusX: 700,
      cactusY: 0,

      coneWidth: 70,
      coneHeight: 70,

      baseVelocityX: -480,
      velocityX: -480,
      velocityY: 0,
      gravity: 2800,

      speedMultiplier: 1.0,
      speedIncreasePerBlood: 0.2,

      gameOver: false,
      score: 0,
      cactusArray: [],
      bloodArray: [],

      bloodWidth: 50,
      bloodHeight: 60,
      bloodY: 0,
      collectedBlood: 0,
      bloodGoal: 5, // Reduced goal for faster gameplay

      lives: 3,

      hospitalWidth: 110,
      hospitalHeight: 130,
      hospital: null,
      hospitalVisible: false,

      runFrame: 0,
      runFrameCount: 2,
      animationTimer: 0,
      animationDuration: 0.15,

      lastTime: 0,
      deltaTime: 0,
      frameCount: 0,
      fpsTimer: 0,
      currentFPS: 60,

      cactusSpawnTimer: 0,
      bloodSpawnTimer: 0,
      baseCactusSpawnInterval: 1.2,
      baseBloodSpawnInterval: 1.5,
      cactusSpawnInterval: 1.2,
      bloodSpawnInterval: 1.5,

      background: {
        x: 0,
        baseSpeed: 150,
        currentSpeed: 150,
        width: 700, // Canvas width
        height: 220, // Canvas height
        actualWidth: 2440,
        actualHeight: 220,
        loopWidth: 2440 // Bagian yang akan di-loop (bisa diatur sesuai asset)
      },

      speedIncreasePerBlood: 0.15,
      maxSpeedMultiplier: 2.5,

      // Game images
      images: {}
    };

    // Elements
    const controls = document.getElementById('controls');
    const items = document.querySelectorAll('.item');
    const messageEl = document.getElementById('message');
    const nextBtn = document.getElementById('next-btn');
    const alertEl = document.getElementById('alert');
    const sceneContent = document.getElementById('scene-content');
    const transitionOverlay = document.getElementById('transition-overlay');
    const stageTitle = document.getElementById('stage-title');
    const stageDesc = document.getElementById('stage-desc');

    // Scene elements
    const patientEl = document.querySelector('.patient');
    const patientTargetEl = document.getElementById('patient-target');
    const armEl = document.querySelector('#arm');
    const cleanedAreaEl = document.getElementById('cleaned-area');
    const bandageEl = document.getElementById('bandage');
    const bloodSampleEl = document.getElementById('blood-sample');
    const testResultEl = document.getElementById('test-result');
    const bloodBagEl = document.getElementById('blood-bag');
    const bloodTypeText = document.getElementById('blood-type-text');
    const laboratoryEl = document.getElementById('laboratory');
    const transfusionRoomEl = document.getElementById('transfusion-room');
    const transfusionTubeEl = document.getElementById('transfusion-tube');
    const dropZoneEl = document.getElementById('drop-zone');
    const instructionText = document.getElementById('instruction-text');
    const transfusionStandEl = document.getElementById('transfusion-stand');

    // Lab test elements
    const labBloodSampleEl = document.getElementById('lab-blood-sample');
    const testPlateA = document.getElementById('test-plate-a');
    const testPlateB = document.getElementById('test-plate-b');
    const testPlateRh = document.getElementById('test-plate-rh');
    const resultA = document.getElementById('result-a');
    const resultB = document.getElementById('result-b');
    const resultRh = document.getElementById('result-rh');
    const bloodTypeSelection = document.getElementById('blood-type-selection');
    const aboButtons = document.getElementById('abo-buttons');
    const rhButtons = document.getElementById('rh-buttons');
    const confirmSelection = document.getElementById('confirm-selection');
    const testResultDisplay = document.getElementById('test-result-display');
    const resultText = document.getElementById('result-text');

    // Blood group selection elements
    const btnA = document.getElementById('btn-a');
    const btnB = document.getElementById('btn-b');
    const btnAB = document.getElementById('btn-ab');
    const btnO = document.getElementById('btn-o');
    const btnRhPos = document.getElementById('btn-rh-pos');
    const btnRhNeg = document.getElementById('btn-rh-neg');
    const btnConfirm = document.getElementById('btn-confirm');

    // Setup
    setupEventListeners();

    // Setup initial controls for donor stage
    updateControlsForStage('donor');

    function fadeToTapGame() {
      const overlay = document.getElementById('main-fade-overlay');
      const fadeText = document.getElementById('fade-text');

      fadeText.textContent = 'Collecting blood from donors...';
      overlay.classList.add('active');

      setTimeout(() => {
        // Sembunyikan scene utama dan tampilkan tap game
        document.getElementById('simulation').style.display = 'none';
        document.getElementById('tap-game-overlay').style.display = 'block';

        // Mulai tap game
        initTapGame();

        // Fade out overlay
        setTimeout(() => {
          overlay.classList.remove('active');
        }, 500);
      }, 1000);
    }

    function fadeBackToDonor() {
      const overlay = document.getElementById('main-fade-overlay');
      const fadeText = document.getElementById('fade-text');

      fadeText.textContent = 'Back to the donor process...';
      overlay.classList.add('active');

      setTimeout(() => {
        // Sembunyikan tap game dan tampilkan scene utama
        document.getElementById('tap-game-overlay').style.display = 'none';
        document.getElementById('simulation').style.display = 'block';

        // Update game state
        gameState.bloodCollected = true;
        messageEl.textContent = 'Blood collection is complete. Place a plaster on the arm.';
        showAlert('Blood successfully collected!');

        // Fade out overlay
        setTimeout(() => {
          overlay.classList.remove('active');
        }, 500);
      }, 1000);
    }

    function initTapGame() {
      tapGameState.canvas = document.getElementById('tap-canvas');
      tapGameState.ctx = tapGameState.canvas.getContext('2d');
      tapGameState.active = false;
      tapGameState.score = 0;
      tapGameState.progress = 0;
      tapGameState.gameTime = 0;
      tapGameState.spawnTimer = 0;
      tapGameState.circles = [];

      updateTapUI();

      // Event listener untuk klik
      tapGameState.canvas.addEventListener('click', handleTapClick);

      // Show legend
      const legend = document.getElementById('tap-legend');
      if (legend) {
        legend.classList.remove('hidden');
      }

      // Show intro popup
      showTapGameIntro();

      // Mulai game loop
      tapGameLoop();
    }

    function handleTapClick(e) {
      if (!tapGameState.active) return;
      const rect = tapGameState.canvas.getBoundingClientRect();
      const mouseX = e.clientX - rect.left;
      const mouseY = e.clientY - rect.top;

      for (let i = 0; i < tapGameState.circles.length; i++) {
        const c = tapGameState.circles[i];
        const dx = mouseX - c.x;
        const dy = mouseY - c.y;
        if (Math.sqrt(dx * dx + dy * dy) < tapGameState.radius) {
          if (c.type === 'bacteria') {
            // Stop the game temporarily
            tapGameState.active = false;

            // Show bacteria notification popup
            showBacteriaNotification();

            // Remove the clicked bacteria
            tapGameState.circles.splice(i, 1);
            return;
          } else {
            c.shrinking = true;
            c.frame = 10;
            tapGameState.score += 10;
            tapGameState.progress += 10;
            if (tapGameState.progress > tapGameState.maxProgress) {
              tapGameState.progress = tapGameState.maxProgress;
            }
            updateTapUI();
            return;
          }
        }
      }
    }

    function tapGameOver() {
      alert("You're suppressing bacteria! Try again.");
      tapGameState.score = 0;
      tapGameState.progress = 0;
      tapGameState.gameTime = 0;
      tapGameState.spawnTimer = 0;
      tapGameState.circles = [];
      updateTapUI();
    }

    function spawnTapCircle() {
      if (tapGameState.circles.length >= tapGameState.maxCircles) return;

      let attempts = 0;
      let newPos, newCircle;
      do {
        newPos = {
          x: Math.random() * (tapGameState.canvas.width - tapGameState.radius * 2) + tapGameState.radius,
          y: Math.random() * (tapGameState.canvas.height - tapGameState.radius * 2) + tapGameState.radius
        };
        newCircle = {
          x: newPos.x,
          y: newPos.y,
          type: Math.random() < 0.25 ? 'bacteria' : 'blood',
          shrinking: false,
          frame: 10,
          lifeTime: 240
        };
        attempts++;
      } while (isTapOverlapping(newCircle) && attempts < 15);

      if (attempts < 15) {
        tapGameState.circles.push(newCircle);
      }
    }

    function isTapOverlapping(newCircle) {
      for (const c of tapGameState.circles) {
        const dx = c.x - newCircle.x;
        const dy = c.y - newCircle.y;
        const distance = Math.sqrt(dx * dx + dy * dy);
        if (distance < tapGameState.radius * 2.2) {
          return true;
        }
      }
      return false;
    }

    function drawTapCircles() {
      tapGameState.ctx.clearRect(0, 0, tapGameState.canvas.width, tapGameState.canvas.height);
      for (let i = 0; i < tapGameState.circles.length; i++) {
        const c = tapGameState.circles[i];
        const r = c.shrinking ? tapGameState.radius * (c.frame / 10) : tapGameState.radius;
        const size = r * 2;

        let image = c.type === 'blood' ? tapBloodImage : tapBacteriaImage;
        tapGameState.ctx.drawImage(image, c.x - r, c.y - r, size, size);

        if (c.shrinking) {
          c.frame--;
          if (c.frame <= 0) {
            tapGameState.circles.splice(i, 1);
            i--;
          }
        } else {
          c.lifeTime--;
          if (c.lifeTime <= 0) {
            tapGameState.circles.splice(i, 1);
            i--;
          }
        }
      }
    }

    function updateTapUI() {
      document.getElementById('tap-score').innerText = tapGameState.score;
      const fillPercentage = (tapGameState.progress / tapGameState.maxProgress) * 13;
      document.getElementById('tap-blood-fill').style.height = fillPercentage + '%';
      if (tapGameState.progress >= tapGameState.maxProgress && tapGameState.active) {
        tapGameState.active = false;
        setTimeout(() => {
          fadeBackToDonor();
        }, 500);
      }
    }

    function getTapSpawnRate() {
      const baseRate = 60;
      const minRate = 20;
      const timeProgression = Math.min(tapGameState.gameTime / 3600, 1);
      return baseRate - (baseRate - minRate) * timeProgression;
    }

    function tapGameLoop() {
      // Selalu render untuk menampilkan pesan atau game
      drawTapCircles();

      // Hanya update game logic jika game aktif
      if (!tapGameState.active) {
        requestAnimationFrame(tapGameLoop);
        return;
      }

      tapGameState.gameTime++;
      tapGameState.spawnTimer++;

      const currentSpawnRate = getTapSpawnRate();
      if (tapGameState.spawnTimer >= currentSpawnRate) {
        spawnTapCircle();
        tapGameState.spawnTimer = 0;
      }

      requestAnimationFrame(tapGameLoop);
    }

    function setupEventListeners() {
      // Arm interaction
      armEl.addEventListener('click', () => {
        if (selectedItem) {
          useItemOnArm(selectedItem.dataset.item);
        }
      });

      // Next button
      nextBtn.addEventListener('click', moveToNextStage);

      // Blood group selection buttons
      btnA.addEventListener('click', () => selectBloodGroup('A'));
      btnB.addEventListener('click', () => selectBloodGroup('B'));
      btnAB.addEventListener('click', () => selectBloodGroup('AB'));
      btnO.addEventListener('click', () => selectBloodGroup('O'));
      btnRhPos.addEventListener('click', () => selectRhFactor('+'));
      btnRhNeg.addEventListener('click', () => selectRhFactor('-'));
      btnConfirm.addEventListener('click', confirmBloodGroup);
    }

    function updateControlsForStage(stage) {
      controls.innerHTML = ''; // Clear existing controls

      switch (stage) {
        case 'donor':
          addControlItem('cotton', 'Alcohol Cotton', `
                <svg viewBox="0 0 60 60">
                    <rect x="10" y="25" width="40" height="10" rx="5" fill="#e0e0e0" stroke="#bdbdbd" stroke-width="1" />
                    <circle cx="10" cy="30" r="8" fill="#fff" stroke="#bdbdbd" />
                    <circle cx="50" cy="30" r="8" fill="#fff" stroke="#bdbdbd" />
                    <text x="30" y="55" text-anchor="middle" font-size="8">Alcohol Cotton</text>
                </svg>
            `);

          addControlItem('syringe', 'Syringe', `
                <svg viewBox="0 0 60 60">
                    <rect x="10" y="25" width="30" height="10" rx="2" fill="#bbdefb" stroke="#1976d2" />
                    <rect x="40" y="27" width="15" height="6" fill="#e0e0e0" stroke="#bdbdbd" />
                    <path d="M55 30 L60 30" stroke="#bdbdbd" stroke-width="1" />
                    <rect x="5" y="27" width="5" height="6" fill="#42a5f5" />
                    <text x="30" y="55" text-anchor="middle" font-size="8">Syringe</text>
                </svg>
            `);

          addControlItem('bandage', 'Bandage', `
                <svg viewBox="0 0 60 60">
                    <rect x="10" y="25" width="40" height="10" rx="2" fill="#ffe0b2" stroke="#ff9800" />
                    <rect x="20" y="25" width="20" height="10" fill="#f5f5f5" />
                    <line x1="15" y1="20" x2="15" y2="40" stroke="#ff9800" stroke-width="1" />
                    <line x1="25" y1="20" x2="25" y2="40" stroke="#ff9800" stroke-width="1" />
                    <line x1="35" y1="20" x2="35" y2="40" stroke="#ff9800" stroke-width="1" />
                    <line x1="45" y1="20" x2="45" y2="40" stroke="#ff9800" stroke-width="1" />
                    <text x="30" y="55" text-anchor="middle" font-size="8">Plaster</text>
                </svg>
            `);
          break;
      }
      setupControlItemListeners();
    }

    function addControlItem(itemName, title, svgContent) {
      const itemDiv = document.createElement('div');
      itemDiv.className = 'item';
      itemDiv.dataset.item = itemName;
      itemDiv.title = title;
      itemDiv.innerHTML = svgContent;
      controls.appendChild(itemDiv);
    }

    function setupControlItemListeners() {
      const items = document.querySelectorAll('.item');
      items.forEach(item => {
        item.addEventListener('click', () => selectItem(item));
      });
    }

    function selectItem(item) {
      items.forEach(i => i.classList.remove('selected'));
      item.classList.add('selected');
      selectedItem = item;
      messageEl.textContent = `You select ${item.title || item.dataset.item}. Click on the patient's arm to use.`;
    }

    function useItemOnArm(item) {
      switch (item) {
        case 'cotton':
          if (!gameState.armCleaned) {
            cleanArm();
          } else {
            showAlert('Arms have been cleaned');
          }
          break;
        case 'syringe':
          if (gameState.armCleaned && !gameState.bloodCollected) {
            collectBlood();
          } else if (!gameState.armCleaned) {
            showAlert('Clean the arm first with an alcohol swab');
          } else {
            showAlert('Blood has been taken');
          }
          break;
        case 'bandage':
          if (gameState.bloodCollected && !gameState.bandageApplied) {
            applyBandage();
          } else if (!gameState.bloodCollected) {
            showAlert('Draw blood first');
          } else {
            showAlert('Plaster has been applied');
          }
          break;
        case 'test':
          if (gameState.bloodCollected && !gameState.testDone) {
            testBlood();
          } else if (!gameState.bloodCollected) {
            showAlert('Draw blood first');
          } else {
            showAlert('The test has been done');
          }
          break;
        case 'bag':
          if (currentStage === 'transfusion') {
            useBloodBag();
          } else {
            showAlert('Blood bags will be used at the transfusion stage');
          }
          break;
      }
    }

    function cleanArm() {
      cleanedAreaEl.style.display = 'block';
      gameState.armCleaned = true;
      messageEl.textContent = 'The arm has been cleaned. Draw blood with a syringe.';
      showAlert('Arm has been cleaned!');
    }

    function collectBlood() {
      // Tampilkan sample darah
      bloodSampleEl.style.display = 'block';
      messageEl.textContent = 'Taking blood... The blood collection process begins.';

      const bloodSample = document.getElementById('blood-sample');
      bloodSample.style.top = '100px';
      bloodSample.style.right = '100px';

      // Fade ke tap game
      setTimeout(() => {
        fadeToTapGame();
      }, 1500);
    }

    function applyBandage() {
      bandageEl.style.display = 'block';
      gameState.bandageApplied = true;
      messageEl.textContent = 'The Bandage has been applied. The blood donation process is complete! Click the “Next” button to take a blood test.';
      showAlert('Bandage applied, blood donation completed!');
      nextBtn.disabled = false;
    }

    function testBlood() {
      testResultEl.style.display = 'block';
      testResultEl.innerHTML = `<strong>Blood Type:</strong><br>${gameState.donorBloodType}`;
      gameState.testDone = true;
      messageEl.textContent = 'Blood tests have been conducted. Blood type has been identified.';
      showAlert(`Blood type identified: ${gameState.donorBloodType}`);
      nextBtn.disabled = false;
    }

    function useBloodBag() {
      messageEl.textContent = 'Attach the blood bag to the infusion pole and connect it to the patient..';
      showAlert('Use blood bags for transfusion');
    }

    function moveToNextStage() {
      nextBtn.disabled = true;

      console.log('🔄 Moving to next stage. Current stage:', currentStage);
      console.log('📊 Game state:', gameState);

      if (currentStage === 'donor' && gameState.bandageApplied) {
        showTransition('Laboratory', 'Time to determine your blood type at the lab.');
        setTimeout(() => {
          currentStage = 'laboratory';
          startLaboratoryStage();
          controls.style.display = 'none';
          updateControlsForStage('laboratory');
        }, 2000);
      }
      else if (currentStage === 'laboratory' && gameState.bloodGroupIdentified) {
        console.log('🧪 Laboratory completed, moving to Blood Run...');

        // Hide blood type selection elements
        const bloodTypeSelection = document.getElementById('blood-type-selection-container');
        if (bloodTypeSelection) {
          bloodTypeSelection.classList.add('hidden');
        }

        const testResultDisplay = document.getElementById('test-result-display');
        if (testResultDisplay) {
          testResultDisplay.classList.add('hidden');
        }

        showTransition('Blood Delivery', 'Deliver the blood safely to the hospital!');
        setTimeout(() => {
          currentStage = 'blood-run';
          console.log('🏃 Starting Blood Run game...');

          // Check if function exists before calling
          if (typeof startBloodRunGame === 'function') {
            startBloodRunGame();
          } else {
            console.error('❌ startBloodRunGame function not found!');
            showAlert('Blood Run game not available. Moving to transfusion.', 'error');
            // Skip to transfusion if Blood Run fails
            setTimeout(() => {
              currentStage = 'transfusion';
              startTransfusionStage();
              updateControlsForStage('transfusion');
              controls.style.display = 'none';
            }, 1000);
          }
        }, 2000);
      }
      else if (currentStage === 'blood-run' && bloodRunGame && bloodRunGame.completed) {
        console.log('🏥 Blood Run completed, moving to Transfusion...');

        // Hide blood run game
        const bloodRunGameEl = document.getElementById('blood-run-game');
        if (bloodRunGameEl) {
          bloodRunGameEl.style.display = 'none';
        }

        // Clean up event listeners
        if (bloodRunGame.keyDownHandler) {
          document.removeEventListener('keydown', bloodRunGame.keyDownHandler);
        }
        if (bloodRunGame.keyUpHandler) {
          document.removeEventListener('keyup', bloodRunGame.keyUpHandler);
        }

        showTransition('Blood Transfusion', 'Use blood bags for transfusion to patients.');
        setTimeout(() => {
          currentStage = 'transfusion';
          startTransfusionStage();
          updateControlsForStage('transfusion');
          controls.style.display = 'none';
        }, 2000);
      }
      else if (currentStage === 'transfusion' && gameState.transfusionComplete) {
        showTransition('Completed', 'Blood transfusion was successful.');
        setTimeout(() => {
          messageEl.textContent = 'Simulator is complete. Refresh the page to start over.';
          showAlert('Blood transfusion was successful!', 'success');
        }, 2000);
      }
      else {
        console.log('❓ Stage transition condition not met');
        console.log('Current stage:', currentStage);
        console.log('Game state:', gameState);
        console.log('Blood Run status:', bloodRunGame);
        nextBtn.disabled = false; // Re-enable button if condition not met
      }
    }

    function startLaboratoryStage() {
      // Sembunyikan elemen pasien
      patientEl.style.display = 'none';
      bloodSampleEl.style.display = 'none';
      testResultEl.style.display = 'none';

      // Tampilkan adegan laboratorium
      laboratoryEl.style.display = 'block';

      // Pastikan kontainer terkait pemilihan golongan darah tersembunyi di awal
      const bloodTypeSelection = document.getElementById('blood-type-selection-container');
      if (bloodTypeSelection) {
        bloodTypeSelection.classList.add('hidden');
      }

      const testResultDisplay = document.getElementById('test-result-display');
      if (testResultDisplay) {
        testResultDisplay.classList.add('hidden');
      }

      // Hasilkan golongan darah acak untuk level ini
      generateRandomBloodType();

      // Tampilkan pesan yang menginstruksikan pengguna
      messageEl.textContent = 'Blood type test by dropping a blood sample onto the testing plate, click on the blood sample.';

      // Jadikan sampel darah laboratorium dapat diklik
      labBloodSampleEl.style.cursor = 'pointer';
      labBloodSampleEl.addEventListener('click', startBloodGroupTest);
    }

    // Fungsi untuk menghasilkan golongan darah acak
    function generateRandomBloodType() {
      // Definisikan kemungkinan golongan darah
      const bloodGroups = ['A', 'B', 'AB', 'O'];
      const rhFactors = ['+', '-'];

      // Pilih secara acak
      const randomBloodGroup = bloodGroups[Math.floor(Math.random() * bloodGroups.length)];
      const randomRhFactor = rhFactors[Math.floor(Math.random() * rhFactors.length)];

      // Tetapkan golongan darah acak ke gameState
      gameState.donorBloodType = randomBloodGroup + randomRhFactor;

      console.log("Blood type produced: " + gameState.donorBloodType);
    }


    function startBloodGroupTest() {
      let dropCount = 0;
      const plates = [testPlateA, testPlateB, testPlateRh];

      function createBloodDrop(plate) {
        const dropEl = document.createElement('div');
        dropEl.className = 'blood-drop-animation';

        const plateRect = plate.getBoundingClientRect();
        const labRect = laboratoryEl.getBoundingClientRect();

        dropEl.style.left = (plateRect.left - labRect.left + plateRect.width / 2) + 'px';
        dropEl.style.top = (plateRect.top - labRect.top) + 'px';

        laboratoryEl.appendChild(dropEl);

        setTimeout(() => {
          laboratoryEl.removeChild(dropEl);

          const plateType = plate.dataset.type;
          let reactionResult = false;

          // Tentukan reaksi berdasarkan golongan darah yang ditetapkan
          if (plateType === 'A') {
            // Reaksi penggumpalan terjadi jika golongan darah mengandung A (A atau AB)
            reactionResult = gameState.donorBloodType.includes('A');
          } else if (plateType === 'B') {
            // Reaksi penggumpalan terjadi jika golongan darah mengandung B (B atau AB)
            reactionResult = gameState.donorBloodType.includes('B');
          } else if (plateType === 'Rh') {
            // Reaksi penggumpalan terjadi jika golongan darah Rh positif
            reactionResult = gameState.donorBloodType.includes('+');
          }

          showCoagulation(plateType, reactionResult);

          dropCount++;
          if (dropCount === plates.length) {
            setTimeout(() => {
              showBloodTypeSelectionInterface();
            }, 1000);
          }
        }, 1000);
      }

      plates.forEach((plate, index) => {
        setTimeout(() => {
          createBloodDrop(plate);
        }, index * 1000);
      });

      labBloodSampleEl.style.cursor = 'default';
      labBloodSampleEl.removeEventListener('click', startBloodGroupTest);
      messageEl.textContent = 'Conduct blood type tests...';
    }

    function showCoagulation(plateType, isCoagulated) {
      let resultEl;
      switch (plateType) {
        case 'A': resultEl = resultA; break;
        case 'B': resultEl = resultB; break;
        case 'Rh': resultEl = resultRh; break;
      }

      const offset = plateType === 'A' ? -120 : plateType === 'B' ? 0 : 120;
      const color = isCoagulated ? '#4caf50' : '#f44336';

      resultEl.style.display = 'block';

      if (isCoagulated) {
        resultEl.innerHTML = `
          <circle cx="${offset}" cy="0" r="15" fill="${color}" fill-opacity="0.5" />
          <path d="M${offset - 10} 0 L${offset} 10 L${offset + 10} -10" 
              stroke="${color}" stroke-width="2" fill="none" />
      `;
        showAlert(`Reagent clumping occurs ${plateType}`, 'success');
      } else {
        resultEl.innerHTML = `
          <circle cx="${offset}" cy="0" r="15" fill="${color}" fill-opacity="0.5" />
          <path d="M${offset - 10} -10 L${offset + 10} 10" stroke="${color}" stroke-width="2" />
          <path d="M${offset - 10} 10 L${offset + 10} -10" stroke="${color}" stroke-width="2" />
      `;
        showAlert(`No clumping of reagents ${plateType}`, 'error');
      }
    }


    function showBloodTypeSelectionInterface() {
      // Perbarui pesan
      messageEl.textContent = 'Based on the test results, determine the blood type.';

      // Dapatkan container pemilihan golongan darah
      const selectionContainer = document.getElementById('blood-type-selection-container');
      if (selectionContainer) {
        // Tambahkan petunjuk tentang cara menentukan golongan darah
        // Cek jika petunjuk belum ada
        if (!selectionContainer.querySelector('.helper-box')) {
          const helperBox = document.createElement('div');
          helperBox.className = 'helper-box';
          helperBox.innerHTML = `
              <h4 class="font-bold text-blue-700 mb-2">How to determine blood type:</h4>
              <ul class="list-disc list-inside text-gray-700 space-y-1">
                  <li>If clumping occurs in reagent A: contains antigen A</li>
                  <li>If clumping occurs in reagent B: contains antigen A B</li>
                  <li>If clumping occurs in the Rh reagent: Rhesus positive (+)</li>
                  <li>Type A: clumping only in reagent A</li>
                  <li>Type B: clumping only in reagent B</li>
                  <li>Type AB: clumping in reagents A and B</li>
                  <li>Type O: no clumping in reagents A and B</li>
              </ul>
          `;

          // Sisipkan petunjuk di awal container
          selectionContainer.insertBefore(helperBox, selectionContainer.firstChild);
        }

        // Tampilkan container dengan animasi
        selectionContainer.classList.remove('hidden');
        selectionContainer.classList.add('fade-in');

        // Inisialisasi tombol jika belum dilakukan
        if (!selectionContainer.dataset.initialized) {
          // Event listener untuk tombol golongan darah
          document.querySelectorAll('.blood-type-btn').forEach(btn => {
            btn.addEventListener('click', function () {
              const type = this.textContent;
              selectBloodGroup(type);
            });
          });

          // Event listener untuk tombol rhesus
          document.querySelectorAll('.rh-btn').forEach(btn => {
            btn.addEventListener('click', function () {
              const rhFactor = this.textContent.includes('+') ? '+' : '-';
              selectRhFactor(rhFactor);
            });
          });

          // Event listener untuk tombol konfirmasi
          const confirmBtn = document.getElementById('btn-confirm');
          if (confirmBtn) {
            confirmBtn.addEventListener('click', confirmBloodGroup);
          }

          // Tandai sebagai sudah diinisialisasi
          selectionContainer.dataset.initialized = "true";
        }
      }
    }

    function selectBloodGroup(group) {
      // Reset semua tombol golongan darah ke style default
      document.querySelectorAll('.blood-type-btn').forEach(btn => {
        btn.classList.remove('selected');
      });

      // Tambahkan class selected ke tombol yang diklik
      const btnId = {
        'A': 'btn-a',
        'B': 'btn-b',
        'AB': 'btn-ab',
        'O': 'btn-o'
      }[group];

      const btn = document.getElementById(btnId);
      if (btn) {
        btn.classList.add('selected');
      }

      // Simpan golongan darah yang dipilih
      gameState.selectedGroupABO = group;

      // Periksa apakah seleksi sudah lengkap
      checkSelectionComplete();
    }


    function selectRhFactor(factor) {
      // Reset semua tombol rhesus ke style default
      document.querySelectorAll('.rh-btn').forEach(btn => {
        btn.classList.remove('selected');
      });

      // Tambahkan class selected ke tombol yang diklik
      const btnId = factor === '+' ? 'btn-rh-pos' : 'btn-rh-neg';
      const btn = document.getElementById(btnId);
      if (btn) {
        btn.classList.add('selected');
      }

      // Simpan faktor Rh yang dipilih
      gameState.selectedGroupRh = factor;

      // Periksa apakah seleksi sudah lengkap
      checkSelectionComplete();
    }

    function checkSelectionComplete() {
      // Jika golongan darah dan faktor Rh keduanya sudah dipilih, tampilkan tombol konfirmasi
      if (gameState.selectedGroupABO && gameState.selectedGroupRh) {
        const confirmSelection = document.getElementById('confirm-selection');
        if (confirmSelection) {
          confirmSelection.classList.remove('hidden');
          // Tambahkan animasi fade-in
          confirmSelection.classList.add('fade-in');
        }
      }
    }

    function confirmBloodGroup() {
      // Gabungkan golongan darah dan faktor Rh yang dipilih
      const selectedBloodType = gameState.selectedGroupABO + gameState.selectedGroupRh;

      // Periksa apakah pilihan benar
      const isCorrect = selectedBloodType === gameState.donorBloodType;

      if (isCorrect) {
        // Sembunyikan interface pemilihan golongan darah
        const bloodTypeSelection = document.getElementById('blood-type-selection-container');
        if (bloodTypeSelection) {
          bloodTypeSelection.classList.add('hidden');
        }

        // Tampilkan hasil tes dengan animasi
        const resultDisplay = document.getElementById('test-result-display');
        if (resultDisplay) {
          resultDisplay.classList.remove('hidden');
          resultDisplay.classList.add('success-pulse');

          // Perbarui elemen teks hasil
          document.getElementById('result-text').textContent = `Blood Type: ${selectedBloodType}`;

          // Perbarui tampilan golongan darah
          const resultBloodType = document.getElementById('result-blood-type');
          if (resultBloodType) {
            resultBloodType.textContent = selectedBloodType;
          }
        }

        // Tampilkan pesan berhasil
        showAlert('Blood group identification is correct!', 'success');

        // Perbarui status game dan pesan
        gameState.bloodGroupIdentified = true;
        messageEl.textContent = 'The blood type has been correctly identified. Click the “Next” button to perform the transfusion.';

        // Aktifkan tombol lanjut
        nextBtn.disabled = false;
      } else {
        // Tampilkan pesan kesalahan
        showAlert(`Incorrect blood type identification! Please try again.`, 'error');

        // Reset pilihan tapi biarkan interface tetap terbuka
        resetBloodTypeSelection();

        // Tambahkan animasi flash error
        const bloodTypeContainer = document.getElementById('blood-type-selection-container');
        if (bloodTypeContainer) {
          bloodTypeContainer.classList.add('flash-error');
          setTimeout(() => {
            bloodTypeContainer.classList.remove('flash-error');
          }, 600);
        }
      }
      messageEl.textContent = 'The blood type has been correctly identified. Click the “Next” button to perform the transfusion.';

      // Animasi petunjuk visual tambahan
      createHelpfulHint();
    }

    // Fungsi untuk membuat petunjuk visual ketika pengguna salah
    function createHelpfulHint() {
      // Cek apakah elemen petunjuk sudah ada
      let hintElement = document.querySelector('.blood-type-hint');

      // Jika sudah ada, hapus dulu untuk menghindari duplikasi
      if (hintElement) {
        hintElement.remove();
      }

      // Buat elemen petunjuk baru
      hintElement = document.createElement('div');
      hintElement.className = 'blood-type-hint bg-yellow-50 border-l-4 border-yellow-400 p-3 mb-4 animate-pulse';

      // Dapatkan golongan darah yang benar
      const correctBloodType = gameState.donorBloodType;

      // Petunjuk berdasarkan hasil tes (tanpa memberikan jawaban langsung)
      let hintText = '<h4 class="font-bold text-yellow-700 mb-1">Hint:</h4><ul class="list-disc list-inside text-gray-700 space-y-1">';

      // Petunjuk untuk golongan ABO
      if (correctBloodType.includes('A') && correctBloodType.includes('B')) {
        // AB
        hintText += '<li>Clumping occurs <strong>both reagents A and B</strong></li>';
      } else if (correctBloodType.includes('A')) {
        // A
        hintText += '<li>Clumping occurs in <strong>reagent A only</strong></li>';
      } else if (correctBloodType.includes('B')) {
        // B
        hintText += '<li>Clumping occurs in <strong>reagent B only</strong></li>';
      } else {
        // O
        hintText += '<li>No clumping occurs in <strong>reagents A or B</strong></li>';
      }

      // Petunjuk untuk Rhesus
      if (correctBloodType.includes('+')) {
        hintText += '<li>Clumping occurs in <strong>reagent Rh</strong></li>';
      } else {
        hintText += '<li>No clumping occurs in <strong>reagent Rh</strong></li>';
      }

      hintText += '</ul>';

      // Masukkan teks petunjuk ke elemen
      hintElement.innerHTML = hintText;

      // Masukkan elemen petunjuk ke dalam container
      const bloodTypeSelection = document.getElementById('blood-type-selection-container');
      if (bloodTypeSelection) {
        // Masukkan setelah elemen pertama (judul)
        const firstChild = bloodTypeSelection.firstChild;
        bloodTypeSelection.insertBefore(hintElement, firstChild.nextSibling);
      }
    }


    function resetBloodTypeSelection() {
      // Reset semua tombol golongan darah
      document.querySelectorAll('.blood-type-btn').forEach(btn => {
        btn.classList.remove('selected');
      });

      // Reset semua tombol rhesus
      document.querySelectorAll('.rh-btn').forEach(btn => {
        btn.classList.remove('selected');
      });

      // Sembunyikan tombol konfirmasi
      const confirmSelection = document.getElementById('confirm-selection');
      if (confirmSelection) {
        confirmSelection.classList.add('hidden');
      }

      // Reset nilai yang dipilih
      gameState.selectedGroupABO = '';
      gameState.selectedGroupRh = '';
    }

    // Improved transfusion stage with enhanced drag and drop
    function startTransfusionStage() {
      // Hide laboratory elements
      laboratoryEl.style.display = 'none';

      // Show transfusion scene
      fadeInElement(transfusionRoomEl);

      // Show blood bag with correct blood type
      bloodTypeText.textContent = gameState.donorBloodType;
      bloodBagEl.style.display = 'block';

      // Position the blood bag for better visibility - di posisi awal yang lebih terlihat
      bloodBagEl.style.position = 'absolute';
      bloodBagEl.style.top = '100px';
      bloodBagEl.style.left = '200px';
      bloodBagEl.style.cursor = 'grab';
      bloodBagEl.style.zIndex = '100';

      // Make sure the transfusion tube is hidden initially
      var tubeElement = document.getElementById('transfusion-tube');
      if (tubeElement) {
        tubeElement.style.display = 'none';
      }

      // Highlight drop zone for better visibility
      dropZoneEl.classList.add('drop-zone-highlight');

      // Make IV stand more prominent
      transfusionStandEl.classList.add('stand-highlight');

      messageEl.textContent = 'Attach the blood bag to the infusion pole by drag & drop.';
      showAlert('Drag the blood bag to the infusion pole to start the transfusion', 'info');

      // Setup drag and drop for blood bag
      setupBloodBagDragAndDrop();
    }

    // Drag and drop functionality
    let isDragging = false;
    let dragOffsetX = 0;
    let dragOffsetY = 0;
    let isTransfusionComplete = false;

    function setupBloodBagDragAndDrop() {
      // Remove any existing event listeners
      bloodBagEl.removeEventListener('mousedown', startDrag);
      document.removeEventListener('mousemove', dragMove);
      document.removeEventListener('mouseup', dragEnd);

      // Add new mouse down event listener
      bloodBagEl.addEventListener('mousedown', startDrag);

      // Change cursor style when hovering over blood bag
      bloodBagEl.style.cursor = 'grab';
    }

    function startDrag(e) {
      if (currentStage !== 'transfusion' || isTransfusionComplete) return;

      // Change cursor style when dragging
      bloodBagEl.style.cursor = 'grabbing';

      // Get initial mouse position
      const rect = bloodBagEl.getBoundingClientRect();
      dragOffsetX = e.clientX - rect.left;
      dragOffsetY = e.clientY - rect.top;

      // Add move and end event listeners
      document.addEventListener('mousemove', dragMove);
      document.addEventListener('mouseup', dragEnd);

      isDragging = true;
      e.preventDefault();
    }

    function dragMove(e) {
      if (!isDragging) return;

      // Calculate new position relative to the scene content
      const sceneRect = sceneContent.getBoundingClientRect();
      const x = e.clientX - sceneRect.left - dragOffsetX;
      const y = e.clientY - sceneRect.top - dragOffsetY;

      // Move the blood bag with absolute positioning
      bloodBagEl.style.position = 'absolute';
      bloodBagEl.style.left = x + 'px';
      bloodBagEl.style.top = y + 'px';

      // Highlight drop zone when blood bag is being dragged
      const bagRect = bloodBagEl.getBoundingClientRect();
      const dropRect = dropZoneEl.getBoundingClientRect();

      if (isOverlapping(bagRect, dropRect)) {
        dropZoneEl.classList.add('drop-zone-active');
      } else {
        dropZoneEl.classList.remove('drop-zone-active');
      }
    }

    function dragEnd() {
      if (!isDragging) return;

      // Cek apakah dijatuhkan pada tiang
      const bagRect = bloodBagEl.getBoundingClientRect();
      const dropRect = dropZoneEl.getBoundingClientRect();

      // Reset drag state
      isDragging = false;
      document.removeEventListener('mousemove', dragMove);
      document.removeEventListener('mouseup', dragEnd);

      // PERBAIKAN: Tambahkan pengecekan null untuk bloodBagEl
      if (bloodBagEl) {
        bloodBagEl.style.cursor = 'grab';
      }

      if (isOverlapping(bagRect, dropRect)) {
        // Set transition untuk animasi smooth
        if (bloodBagEl) {
          bloodBagEl.style.transition = 'all 0.3s ease';
        }

        // Get scene dimensions for positioning
        const sceneRect = sceneContent.getBoundingClientRect();

        // Dapatkan posisi drop zone dengan tepat
        const dropZoneRect = dropZoneEl.getBoundingClientRect();

        // Hitung posisi yang lebih tepat untuk kantong darah
        // Sesuaikan dengan posisi drop zone
        const leftPos = (dropZoneRect.left - sceneRect.left) - 20; // Lebih ke kiri dari drop zone
        const topPos = (dropZoneRect.top - sceneRect.top) - 5; // Sedikit di atas drop zone

        // Posisikan kantong darah dengan tepat
        if (bloodBagEl) {
          bloodBagEl.style.left = leftPos + 'px';
          bloodBagEl.style.top = topPos + 'px';
          bloodBagEl.style.transform = 'rotate(0deg)';

          // Tidak perlu drag lagi setelah berhasil ditempatkan
          bloodBagEl.removeEventListener('mousedown', startDrag);
        }

        isTransfusionComplete = true;

        // Tampilkan selang transfusi dengan posisi yang tepat
        setTimeout(() => {
          // PERBAIKAN: Tambahkan pengecekan untuk transfusion room
          const transfusionSvg = document.querySelector(".transfusion-room svg");
          if (!transfusionSvg) {
            console.error('Transfusion room SVG not found');
            return;
          }

          var tubeElement = document.getElementById('transfusion-tube');

          if (!tubeElement) {
            tubeElement = document.createElementNS("http://www.w3.org/2000/svg", "path");
            tubeElement.id = "transfusion-tube";
            transfusionSvg.appendChild(tubeElement);
          }

          // PERBAIKAN: Tambahkan pengecekan sebelum setAttribute
          if (tubeElement) {
            tubeElement.setAttribute('stroke', '#e53935');
            tubeElement.setAttribute('stroke-width', '3');
            tubeElement.setAttribute('fill', 'none');
            tubeElement.setAttribute('stroke-dasharray', '5,5');

            // Sesuaikan path selang berdasarkan posisi baru kantong darah
            const startX = leftPos + 40; // Mulai dari sisi kanan kantong darah
            const startY = topPos + 40; // Mulai dari bagian bawah kantong darah

            // Path yang disesuaikan untuk terhubung dari kantong ke pasien
            tubeElement.setAttribute('d', `M${startX} ${startY} C${startX} ${startY + 50}, 400 250, 240 300`);
            tubeElement.style.display = 'block';
          }

          // Make drop zone invisible but still functional
          if (dropZoneEl) {
            dropZoneEl.style.opacity = '0';
            dropZoneEl.style.pointerEvents = 'auto';
          }

          // Make instruction text invisible
          if (instructionText) {
            instructionText.style.opacity = '0';
            instructionText.style.pointerEvents = 'auto';
          }

          // PERBAIKAN: Pass tubeElement dengan aman
          startTransfusionAnimation(tubeElement);
        }, 300);

        // Tampilkan pesan sukses
        showAlert('Blood bag successfully placed!', 'success');
        messageEl.textContent = 'Blood transfusion is in progress....';
      } else {
        // Jika tidak di drop zone, kembali ke posisi awal
        if (bloodBagEl) {
          bloodBagEl.style.transition = 'all 0.3s ease';
          bloodBagEl.style.left = '200px';
          bloodBagEl.style.top = '100px';
        }

        // Hapus highlight drop zone
        if (dropZoneEl) {
          dropZoneEl.classList.remove('drop-zone-active');
        }
      }
    }


    function isOverlapping(rect1, rect2) {
      return !(rect1.right < rect2.left ||
        rect1.left > rect2.right ||
        rect1.bottom < rect2.top ||
        rect1.top > rect2.bottom);
    }

    function startTransfusionAnimation(tubeElement) {
      // Inisialisasi skill check system
      skillCheckSystem = new SkillCheckSystem();

      // Tambahkan skill check UI ke patient container
      const patientContainer = document.querySelector('.patient-in-bed');
      if (patientContainer) {
        const skillCheckUI = skillCheckSystem.createSkillCheckUI();
        patientContainer.appendChild(skillCheckUI);
      }

      // Reset transfusion progress
      transfusionProgress = 100;
      isTransfusingActive = true;

      // Update progress bar jika ada
      updateTransfusionProgressUI();

      // Mulai interval transfusi
      transfusionInterval = setInterval(() => {
        processTransfusionProgress();
      }, 1000); // Setiap 1.5 detik

      // Animasi selang (kode asli Anda yang sudah ada)
      if (tubeElement) {
        tubeElement.classList.add('blood-flow');
      }

      // Perbaiki CSS untuk animasi blood flow
      const style = document.createElement('style');
      style.textContent = `
    .blood-flow {
        stroke-dasharray: 10, 5;
        animation: flow 5s linear infinite;
        z-index: 10;
    }
    
    @keyframes flow {
        from { stroke-dashoffset: 1000; }
        to { stroke-dashoffset: 0; }
    }
    
    @keyframes pulse {
        from { r: 5; fill: #e53935; }
        to { r: 7; fill: #c62828; }
    }
    `;
      document.head.appendChild(style);

      // Create drip animation
      const drip = document.getElementById('drip');
      if (drip) {
        drip.style.display = 'block';
      } else {
        const dropSvg = document.querySelector(".transfusion-room svg");
        if (dropSvg) {
          const newDrip = document.createElementNS("http://www.w3.org/2000/svg", "circle");
          newDrip.id = "drip";
          newDrip.setAttribute('cx', parseFloat(bloodBagEl.style.left) + 20);
          newDrip.setAttribute('cy', '145');
          newDrip.setAttribute('r', '3');
          newDrip.setAttribute('fill', '#e53935');

          const animate1 = document.createElementNS("http://www.w3.org/2000/svg", "animate");
          animate1.setAttribute('attributeName', 'cy');
          animate1.setAttribute('from', '145');
          animate1.setAttribute('to', '180');
          animate1.setAttribute('dur', '1s');
          animate1.setAttribute('repeatCount', 'indefinite');

          const animate2 = document.createElementNS("http://www.w3.org/2000/svg", "animate");
          animate2.setAttribute('attributeName', 'opacity');
          animate2.setAttribute('from', '1');
          animate2.setAttribute('to', '0');
          animate2.setAttribute('dur', '1s');
          animate2.setAttribute('repeatCount', 'indefinite');

          newDrip.appendChild(animate1);
          newDrip.appendChild(animate2);
          dropSvg.appendChild(newDrip);
        }
      }

      // Tambahkan area klik untuk transfusi
      setupTransfusionClick();
    }

    function processTransfusionProgress() {
      if (!isTransfusingActive) return;

      // 20% chance untuk skill check muncul
      if (Math.random() < 0.2 && !skillCheckSystem.isActive) {
        skillCheckSystem.startSkillCheck();
        return;
      }

      // Progress normal jika tidak ada skill check
      if (!skillCheckSystem.isActive) {
        updateTransfusionProgress(-1);
      }
    }

    function updateTransfusionProgress(change) {
      transfusionProgress += change;
      transfusionProgress = Math.max(0, Math.min(100, transfusionProgress));

      updateTransfusionProgressUI();

      if (transfusionProgress <= 0) {
        completeTransfusion();
      }
    }

    function updateTransfusionProgressUI() {
      // Update progress bar atau UI lainnya
      messageEl.textContent = `Transfusion Progress: ${100 - transfusionProgress}%`;
    }

    function setupTransfusionClick() {
      const transfusionPoint = document.getElementById('transfusion-point');
      if (transfusionPoint) {
        transfusionPoint.style.border = '2px dashed #4caf50';
        transfusionPoint.style.borderRadius = '10px';
        transfusionPoint.title = 'Click to perform transfusion';
      }
    }

    function showSkillCheckFeedback(text, color) {
      const patientContainer = document.querySelector('.patient-in-bed');
      if (!patientContainer) return;

      const feedback = document.createElement('div');
      feedback.textContent = text;
      feedback.style.cssText = `
        position: absolute;
        top: -20px;
        left: 50%;
        transform: translateX(-50%);
        color: ${color};
        font-size: 18px;
        font-weight: bold;
        z-index: 1001;
        text-shadow: 2px 2px 4px rgba(0,0,0,0.8);
        animation: skillCheckFeedback 1.5s ease-out forwards;
    `;

      patientContainer.appendChild(feedback);

      setTimeout(() => {
        if (feedback.parentNode) {
          feedback.remove();
        }
      }, 1500);
    }

    function completeTransfusion() {
      isTransfusingActive = false;

      if (transfusionInterval) {
        clearInterval(transfusionInterval);
        transfusionInterval = null;
      }

      if (skillCheckSystem) {
        skillCheckSystem.stopSkillCheck();
      }

      // Update patient appearance gradually (kode asli Anda)
      const patientElements = document.querySelectorAll('.patient-in-bed rect, .patient-in-bed circle');
      patientElements.forEach(el => {
        if (el.getAttribute('fill') === '#f5cba7') {
          el.style.transition = 'fill 2s';
          el.style.fill = '#ffccbc';
        }
      });

      // Tambahkan animasi pada transfusion point
      const transfusionPoint = document.getElementById('transfusion-point');
      if (transfusionPoint) {
        transfusionPoint.style.animation = 'pulse 1s infinite alternate';
      }

      messageEl.textContent = 'Transfusion completed successfully!';
      showAlert('Blood transfusion completed successfully!', 'success');

      // Enable dan tampilkan tombol "Lanjut"
      gameState.transfusionComplete = true;
      nextBtn.disabled = false;
      nextBtn.style.display = 'block';
      nextBtn.style.opacity = '1';
    }


    function fadeInElement(element) {
      element.style.display = 'block';
      element.classList.add('fade-in');
    }

    function showTransition(title, description) {
      stageTitle.textContent = title;
      stageDesc.textContent = description;
      transitionOverlay.classList.add('active');

      setTimeout(() => {
        transitionOverlay.classList.remove('active');
      }, 2000);
    }

    function showAlert(message, type = 'info') {
      alertEl.textContent = message;
      alertEl.style.display = 'block';
      // Set color based on type
      switch (type) {
        case 'success':
          alertEl.style.backgroundColor = '#4CAF50';
          break;
        case 'error':
          alertEl.style.backgroundColor = '#f44336';
          break;
        default:
          alertEl.style.backgroundColor = '#2196F3';
      }

      setTimeout(() => {
        alertEl.style.display = 'none';
      }, 3000);
    }

    function startBloodRunGame() {
      // Hide laboratory elements
      laboratoryEl.style.display = 'none';

      // Hide blood type selection elements
      const bloodTypeSelection = document.getElementById('blood-type-selection-container');
      if (bloodTypeSelection) {
        bloodTypeSelection.classList.add('hidden');
      }

      const testResultDisplay = document.getElementById('test-result-display');
      if (testResultDisplay) {
        testResultDisplay.classList.add('hidden');
      }

      // Show blood run game
      const bloodRunGameEl = document.getElementById('blood-run-game');
      bloodRunGameEl.style.display = 'block';

      // Hide controls
      controls.style.display = 'none';

      // Initialize game
      initBloodRunGame();

      messageEl.textContent = 'Deliver the blood to the hospital! Press SPACE to jump over obstacles.';
      showAlert('Blood delivery mission started!', 'info');
    }

    function initBloodRunGame() {
      bloodRunGame.canvas = document.getElementById('blood-run-canvas');
      bloodRunGame.ctx = bloodRunGame.canvas.getContext('2d');

      // Initialize game state
      brGameState.boardWidth = bloodRunGame.canvas.width;
      brGameState.boardHeight = bloodRunGame.canvas.height;
      brGameState.dinosaurY = brGameState.boardHeight - brGameState.dinosaurHeight;
      brGameState.cactusY = brGameState.boardHeight - brGameState.cactusHeight;
      brGameState.bloodY = brGameState.boardHeight - brGameState.bloodHeight - 10;
      brGameState.cactusX = brGameState.boardWidth;

      brGameState.hospital = {
        x: brGameState.boardWidth,
        y: brGameState.boardHeight - brGameState.hospitalHeight,
        width: brGameState.hospitalWidth,
        height: brGameState.hospitalHeight
      };

      // Initialize dinosaur
      brGameState.dinosaur = {
        x: brGameState.dinosaurX,
        y: brGameState.dinosaurY,
        width: brGameState.dinosaurWidth,
        height: brGameState.dinosaurHeight,
        img: null,
        isRunning: true
      };

      // Load images
      loadBloodRunImages();

      // Reset game state
      resetBloodRunGame();

      // Start game loop
      bloodRunGame.active = true;
      brGameState.lastTime = 0;
      bloodRunGameLoop(0);

      // Add event listeners
      addBloodRunEventListeners();
    }

    function loadBloodRunImages() {
      const imageList = [
        { name: 'dinosaurRun1', src: 'img/Ghibli Run-High.png' },
        { name: 'dinosaurRun2', src: 'img/Ghibli Run-Pass.png' },
        { name: 'dinosaurDead', src: 'img/ghibli dead.png' },
        { name: 'dinosaurJump', src: 'img/Ghibli Jump.png' },
        { name: 'cactus1', src: 'img/bike.png' },
        { name: 'cactus2', src: 'img/car.png' },
        { name: 'truck', src: 'img/Truck.png' },
        { name: 'cactus3', src: 'img/cone1.png' },
        { name: 'blood', src: 'img/bloodpixel.png' },
        { name: 'hospital', src: 'img/hospital1.png' },
        { name: 'background', src: 'img/background.png' },
      ];

      imageList.forEach(item => {
        const img = new Image();
        img.src = item.src;

        // Callback ketika image ter-load untuk mendapatkan ukuran asli
        img.onload = function () {
          if (item.name === 'background') {
            // Update width background sesuai ukuran asli image
            brGameState.background.actualWidth = this.width;
            brGameState.background.actualHeight = this.height;
            console.log(`Background loaded: ${this.width}x${this.height}`);
          }
        };
        brGameState.images[item.name] = img;
      });

      // Set initial dinosaur image
      setTimeout(() => {
        brGameState.dinosaur.img = brGameState.images.dinosaurRun1;
      }, 100);
    }

    function resetBloodRunGame() {
      brGameState.gameOver = false;
      brGameState.background.x = 0;
      brGameState.score = 0;
      brGameState.cactusArray = [];
      brGameState.bloodArray = [];
      brGameState.collectedBlood = 0;
      brGameState.lives = 3;
      brGameState.speedMultiplier = 1.0;
      brGameState.velocityX = brGameState.baseVelocityX;
      brGameState.velocityY = 0;
      brGameState.hospitalVisible = false;
      brGameState.hospital.x = brGameState.boardWidth;
      brGameState.dinosaur.y = brGameState.dinosaurY;
      brGameState.dinosaur.isRunning = true;
      brGameState.runFrame = 0;
      brGameState.animationTimer = 0;
      brGameState.cactusSpawnTimer = 0;
      brGameState.bloodSpawnTimer = 0;
      brGameState.cactusSpawnInterval = brGameState.baseCactusSpawnInterval;
      brGameState.bloodSpawnInterval = brGameState.baseBloodSpawnInterval;
      brGameState.frameCount = 0;
      brGameState.fpsTimer = 0;
    }

    function bloodRunGameLoop(currentTime) {
      if (!bloodRunGame.active) return;

      // Calculate delta time
      if (brGameState.lastTime === 0) brGameState.lastTime = currentTime;
      brGameState.deltaTime = (currentTime - brGameState.lastTime) / 1000;
      brGameState.lastTime = currentTime;

      // Cap delta time
      brGameState.deltaTime = Math.min(brGameState.deltaTime, 0.033);

      // Update FPS
      brGameState.frameCount++;
      brGameState.fpsTimer += brGameState.deltaTime;
      if (brGameState.fpsTimer >= 1.0) {
        brGameState.currentFPS = Math.round(brGameState.frameCount / brGameState.fpsTimer);
        const fpsElement = document.getElementById('blood-run-fps-value');
        if (fpsElement) fpsElement.textContent = brGameState.currentFPS;
        brGameState.frameCount = 0;
        brGameState.fpsTimer = 0;
      }

      updateBloodRun(brGameState.deltaTime);
      drawBloodRun();

      if (bloodRunGame.active) {
        bloodRunGame.animationId = requestAnimationFrame(bloodRunGameLoop);
      }
    }

    function updateBloodRun(dt) {
      // ===== 1. BACKGROUND SCROLLING WITH SPEED CONTROL =====
      // Background hanya bergerak jika game tidak over
      if (!brGameState.gameOver) {
        // Update background speed berdasarkan speedMultiplier
        brGameState.background.currentSpeed = brGameState.background.baseSpeed * brGameState.speedMultiplier;

        // Apply background movement
        brGameState.background.x -= brGameState.background.currentSpeed * dt;

        // Reset position untuk infinite loop
        if (brGameState.background.x <= -brGameState.background.loopWidth) {
          brGameState.background.x = 0;
        }
      }
      // Jika game over, background akan berhenti bergerak

      // ===== 2. GAME OVER CHECK =====
      if (brGameState.gameOver) {
        // Check for completion (jika sudah sampai hospital)
        if (brGameState.collectedBlood >= brGameState.bloodGoal &&
          brGameState.hospitalVisible &&
          collision(brGameState.dinosaur, brGameState.hospital)) {
          completeBloodRunGame();
        }
        return; // Exit early - background dan game logic stop
      }

      // ===== 3. SPAWN TIMERS UPDATE =====
      brGameState.cactusSpawnTimer += dt;
      brGameState.bloodSpawnTimer += dt;

      // ===== 4. SPAWN OBJECTS =====
      // Spawn obstacles
      if (brGameState.cactusSpawnTimer >= brGameState.cactusSpawnInterval) {
        placeCactusBloodRun();
        brGameState.cactusSpawnTimer = 0;
      }

      // Spawn blood
      if (brGameState.bloodSpawnTimer >= brGameState.bloodSpawnInterval) {
        placeBloodBloodRun();
        brGameState.bloodSpawnTimer = 0;
      }

      // ===== 5. DINOSAUR PHYSICS =====
      // Apply gravity
      brGameState.velocityY += brGameState.gravity * dt;
      brGameState.dinosaur.y += brGameState.velocityY * dt;

      // Ground collision check
      if (brGameState.dinosaur.y > brGameState.dinosaurY) {
        brGameState.dinosaur.y = brGameState.dinosaurY;
        brGameState.velocityY = 0;
        brGameState.dinosaur.isRunning = true;
      }

      // ===== 6. DINOSAUR ANIMATION =====
      if (brGameState.dinosaur.isRunning && brGameState.images.dinosaurRun1) {
        brGameState.animationTimer += dt;
        if (brGameState.animationTimer >= brGameState.animationDuration) {
          brGameState.runFrame = (brGameState.runFrame + 1) % brGameState.runFrameCount;
          brGameState.dinosaur.img = brGameState.runFrame === 0 ?
            brGameState.images.dinosaurRun1 : brGameState.images.dinosaurRun2;
          brGameState.animationTimer = 0;
        }
      }

      // ===== 7. UPDATE OBSTACLES =====
      for (let i = 0; i < brGameState.cactusArray.length; i++) {
        const cactus = brGameState.cactusArray[i];

        // Move obstacle
        cactus.x += brGameState.velocityX * dt;

        // Remove obstacle if off screen
        if (cactus.x + cactus.width < 0) {
          brGameState.cactusArray.splice(i, 1);
          i--;
          continue;
        }

        // Check collision with dinosaur
        if (collision(brGameState.dinosaur, cactus)) {
          brGameState.cactusArray.splice(i, 1);
          i--;
          brGameState.lives--;

          // Game over if no lives left
          if (brGameState.lives <= 0) {
            brGameState.gameOver = true;
            brGameState.dinosaur.img = brGameState.images.dinosaurDead;
            brGameState.dinosaur.isRunning = false;

            console.log('💀 Game Over! Lives: 0');
          } else {
            console.log(`💥 Hit obstacle! Lives remaining: ${brGameState.lives}`);
          }
        }
      }

      // ===== 8. UPDATE BLOOD ITEMS =====
      for (let i = 0; i < brGameState.bloodArray.length; i++) {
        const blood = brGameState.bloodArray[i];

        // Move blood item
        blood.x += brGameState.velocityX * dt;

        // Remove blood if off screen
        if (blood.x + blood.width < 0) {
          brGameState.bloodArray.splice(i, 1);
          i--;
          continue;
        }

        // Check collision with dinosaur
        if (collision(brGameState.dinosaur, blood)) {
          brGameState.collectedBlood++;
          brGameState.bloodArray.splice(i, 1);
          i--;

          // ===== SPEED INCREASE LOGIC =====
          const oldSpeedMultiplier = brGameState.speedMultiplier;
          const oldBackgroundSpeed = brGameState.background.currentSpeed;

          // Increase speed
          brGameState.speedMultiplier = Math.min(
            brGameState.speedMultiplier + brGameState.speedIncreasePerBlood,
            brGameState.maxSpeedMultiplier || 2.5
          );

          // Update game velocities
          brGameState.velocityX = brGameState.baseVelocityX * brGameState.speedMultiplier;

          // Update background speed (akan diupdate di loop berikutnya)
          const newBackgroundSpeed = brGameState.background.baseSpeed * brGameState.speedMultiplier;

          // Log speed changes
          console.log(`🩸 Blood collected! (#${brGameState.collectedBlood})`);
          console.log(`🏃 Game Speed: ${oldSpeedMultiplier.toFixed(2)}x → ${brGameState.speedMultiplier.toFixed(2)}x`);
          console.log(`🌆 Background: ${oldBackgroundSpeed.toFixed(0)}px/s → ${newBackgroundSpeed.toFixed(0)}px/s`);

          // Update spawn intervals (lebih sering spawn saat speed tinggi)
          brGameState.cactusSpawnInterval = Math.max(
            0.6,
            brGameState.baseCactusSpawnInterval / brGameState.speedMultiplier
          );
          brGameState.bloodSpawnInterval = Math.max(
            0.8,
            brGameState.baseBloodSpawnInterval / brGameState.speedMultiplier
          );

          // Show hospital when blood goal reached
          if (brGameState.collectedBlood >= brGameState.bloodGoal) {
            brGameState.hospitalVisible = true;
            brGameState.hospital.x = brGameState.boardWidth;
            console.log(`🏥 Hospital appeared! Goal reached: ${brGameState.collectedBlood}/${brGameState.bloodGoal}`);
          }
        }
      }

      // ===== 9. UPDATE HOSPITAL =====
      if (brGameState.hospitalVisible) {
        // Move hospital
        brGameState.hospital.x += brGameState.velocityX * dt;

        // Check collision with dinosaur (win condition)
        if (collision(brGameState.dinosaur, brGameState.hospital)) {
          brGameState.gameOver = true;
          console.log('🎉 Blood delivered to hospital! Mission accomplished!');

          // Trigger completion
          setTimeout(() => {
            completeBloodRunGame();
          }, 500);
        }
      }
    }

    function drawBloodRun() {
      const ctx = bloodRunGame.ctx;
      const canvas = bloodRunGame.canvas;

      ctx.clearRect(0, 0, canvas.width, canvas.height);

      // Draw scrolling background dengan seamless looping
      if (brGameState.images.background) {
        const bg = brGameState.background;

        // Hitung berapa bagian dari image yang terlihat
        const sourceX = Math.abs(bg.x) % bg.loopWidth;
        const sourceWidth = Math.min(bg.loopWidth - sourceX, canvas.width);

        // Draw bagian pertama
        ctx.drawImage(
          brGameState.images.background,
          sourceX, 0, sourceWidth, bg.actualHeight, // Source rectangle
          0, 0, sourceWidth, canvas.height          // Destination rectangle
        );

        // Jika perlu, draw bagian kedua untuk seamless loop
        if (sourceWidth < canvas.width) {
          const remainingWidth = canvas.width - sourceWidth;
          ctx.drawImage(
            brGameState.images.background,
            0, 0, remainingWidth, bg.actualHeight,     // Source rectangle (dari awal image)
            sourceWidth, 0, remainingWidth, canvas.height // Destination rectangle
          );
        }
      }

      // Draw dinosaur
      if (brGameState.dinosaur.img) {
        ctx.drawImage(brGameState.dinosaur.img, brGameState.dinosaur.x, brGameState.dinosaur.y,
          brGameState.dinosaur.width, brGameState.dinosaur.height);
      }

      // Draw obstacles
      brGameState.cactusArray.forEach(c => {
        if (c.img) ctx.drawImage(c.img, c.x, c.y, c.width, c.height);
      });

      // Draw blood
      brGameState.bloodArray.forEach(b => {
        if (b.img) ctx.drawImage(b.img, b.x, b.y, b.width, b.height);
      });

      // Draw hospital
      if (brGameState.hospitalVisible && brGameState.images.hospital) {
        ctx.drawImage(brGameState.images.hospital, brGameState.hospital.x, brGameState.hospital.y,
          brGameState.hospital.width, brGameState.hospital.height);
      }

      // Draw UI
      ctx.fillStyle = 'black';
      ctx.font = '18px Arial';
      ctx.fillText("Blood: " + brGameState.collectedBlood + "/" + brGameState.bloodGoal, 10, 45);
      ctx.fillText("Lives: " + brGameState.lives, 10, 65);
      ctx.fillText("Speed: " + (brGameState.speedMultiplier * 100).toFixed(0) + "%", 10, 85);

      if (brGameState.gameOver) {
        const msg = (brGameState.collectedBlood >= brGameState.bloodGoal &&
          brGameState.hospitalVisible &&
          collision(brGameState.dinosaur, brGameState.hospital))
          ? "Blood delivered successfully!"
          : "Game Over! Press SPACE to retry";

        ctx.fillStyle = 'red';
        ctx.font = 'bold 20px Arial';
        const textWidth = ctx.measureText(msg).width;
        ctx.fillText(msg, (canvas.width - textWidth) / 2, canvas.height / 2);
      }
    }

    function placeCactusBloodRun() {
      if (brGameState.gameOver) return;

      const chance = Math.random();
      let cactus;

      if (chance > 0.9) {
        // Truck - rintangan paling sulit (10% chance)
        cactus = {
          x: brGameState.cactusX,
          y: brGameState.boardHeight - brGameState.truckHeight,
          width: brGameState.truckWidth,
          height: brGameState.truckHeight,
          img: brGameState.images.truck
        };
      } else if (chance > 0.75) {
        // Cone (15% chance)
        cactus = {
          x: brGameState.cactusX,
          y: brGameState.boardHeight - brGameState.coneHeight,
          width: brGameState.coneWidth,
          height: brGameState.coneHeight,
          img: brGameState.images.cactus3
        };
      } else if (chance > 0.5) {
        // Car (25% chance)
        cactus = {
          x: brGameState.cactusX,
          y: brGameState.cactusY,
          width: brGameState.cactus2Width,
          height: brGameState.cactusHeight,
          img: brGameState.images.cactus2
        };
      } else if (chance > 0.3) {
        // Bike (20% chance)
        cactus = {
          x: brGameState.cactusX,
          y: brGameState.cactusY,
          width: brGameState.cactus1Width,
          height: brGameState.cactusHeight,
          img: brGameState.images.cactus1
        };
      }

      if (cactus) brGameState.cactusArray.push(cactus);
      if (brGameState.cactusArray.length > 10) brGameState.cactusArray.shift();
    }

    function placeBloodBloodRun() {
      if (brGameState.gameOver || brGameState.collectedBlood >= brGameState.bloodGoal) return;

      if (Math.random() > 0.7) {
        const newBlood = {
          x: brGameState.boardWidth + (Math.random() * 100),
          y: brGameState.bloodY,
          width: brGameState.bloodWidth,
          height: brGameState.bloodHeight,
          img: brGameState.images.blood
        };

        // Simple position check
        let safe = true;
        for (let cactus of brGameState.cactusArray) {
          if (Math.abs(newBlood.x - cactus.x) < 100) {
            safe = false;
            break;
          }
        }

        if (safe) brGameState.bloodArray.push(newBlood);
      }

      if (brGameState.bloodArray.length > 10) brGameState.bloodArray.shift();
    }

    function collision(a, b) {
      return (
        a.x < b.x + b.width &&
        a.x + a.width > b.x &&
        a.y < b.y + b.height &&
        a.y + a.height > b.y
      );
    }

    function completeBloodRunGame() {
      bloodRunGame.completed = true;
      bloodRunGame.active = false;

      if (bloodRunGame.animationId) {
        cancelAnimationFrame(bloodRunGame.animationId);
      }

      setTimeout(() => {
        showAlert('Blood delivery mission completed!', 'success');
        messageEl.textContent = 'Blood successfully delivered! Click "Next" to proceed to transfusion.';
        nextBtn.disabled = false;
      }, 1000);
    }

    function addBloodRunEventListeners() {
      let spacePressed = false;

      function handleKeyDown(e) {
        if (e.code === 'Space' && bloodRunGame.active) {
          e.preventDefault();

          if (!spacePressed) {
            spacePressed = true;

            if (!brGameState.gameOver && brGameState.dinosaur.y === brGameState.dinosaurY) {
              brGameState.velocityY = -850;
              brGameState.dinosaur.img = brGameState.images.dinosaurJump;
              brGameState.dinosaur.isRunning = false;
            }

            if (brGameState.gameOver && !bloodRunGame.completed) {
              resetBloodRunGame();
              brGameState.dinosaur.img = brGameState.images.dinosaurRun1;
            }
          }
        }
      }

      function handleKeyUp(e) {
        if (e.code === 'Space') {
          spacePressed = false;
        }
      }

      document.addEventListener('keydown', handleKeyDown);
      document.addEventListener('keyup', handleKeyUp);

      // Store references for cleanup
      bloodRunGame.keyDownHandler = handleKeyDown;
      bloodRunGame.keyUpHandler = handleKeyUp;
    }

    let skillCheckSystem = null;
    let transfusionProgress = 100; // Blood level pasien (mulai dari 100)
    let transfusionInterval = null;
    let isTransfusingActive = false;

    class SkillCheckSystem {
      constructor() {
        this.isActive = false;
        this.skillCheckProgress = 0;
        this.skillCheckSpeed = 1; // Kecepatan jarum
        this.safeZoneStart = 30;
        this.safeZoneWidth = 25;
        this.bonusZoneStart = 40;
        this.bonusZoneWidth = 10;
        this.skillCheckDirection = 1;
        this.skillCheckContainer = null;
        this.skillCheckBar = null;
        this.skillCheckNeedle = null;
      }

      createSkillCheckUI() {
        // Container utama skill check
        this.skillCheckContainer = document.createElement('div');
        this.skillCheckContainer.className = 'skill-check-container';
        this.skillCheckContainer.style.cssText = `
            position: absolute;
            top: 250px;
            left: 65%;
            transform: translateX(-50%);
            width: 300px;
            height: 70px;
            background: rgba(0, 0, 0, 0.9);
            border: 3px solid #fff;
            border-radius: 15px;
            display: none;
            z-index: 1000;
            box-shadow: 0 0 20px rgba(0,0,0,0.8);
        `;

        // Bar skill check
        this.skillCheckBar = document.createElement('div');
        this.skillCheckBar.className = 'skill-check-bar';
        this.skillCheckBar.style.cssText = `
            position: relative;
            width: 250px;
            height: 25px;
            background: #333;
            margin: 15px auto 5px auto;
            border-radius: 12px;
            overflow: hidden;
            border: 2px solid #555;
        `;

        // Safe zone
        const safeZone = document.createElement('div');
        safeZone.className = 'safe-zone';
        safeZone.style.cssText = `
            position: absolute;
            height: 100%;
            background: rgba(76, 175, 80, 0.6);
            border: 2px solid #4caf50;
            left: ${this.safeZoneStart}%;
            width: ${this.safeZoneWidth}%;
            border-radius: 8px;
        `;

        // Bonus zone
        const bonusZone = document.createElement('div');
        bonusZone.className = 'bonus-zone';
        bonusZone.style.cssText = `
            position: absolute;
            height: 100%;
            background: rgba(255, 193, 7, 0.8);
            border: 2px solid #ffc107;
            left: ${this.bonusZoneStart}%;
            width: ${this.bonusZoneWidth}%;
            border-radius: 8px;
        `;

        // Jarum
        this.skillCheckNeedle = document.createElement('div');
        this.skillCheckNeedle.className = 'skill-check-needle';
        this.skillCheckNeedle.style.cssText = `
            position: absolute;
            width: 4px;
            height: 100%;
            background: linear-gradient(to bottom, #ff5722, #d32f2f);
            left: 0%;
            border-radius: 2px;
            box-shadow: 0 0 8px rgba(244, 67, 54, 0.8);
        `;

        // Text instruction
        const instructionText = document.createElement('div');
        instructionText.textContent = 'Tekan SPACE saat jarum di zona hijau!';
        instructionText.style.cssText = `
            color: white;
            font-size: 11px;
            text-align: center;
            margin-top: 5px;
            font-weight: bold;
        `;

        this.skillCheckBar.appendChild(safeZone);
        this.skillCheckBar.appendChild(bonusZone);
        this.skillCheckBar.appendChild(this.skillCheckNeedle);
        this.skillCheckContainer.appendChild(this.skillCheckBar);
        this.skillCheckContainer.appendChild(instructionText);

        return this.skillCheckContainer;
      }

      generateRandomZones() {
        this.safeZoneStart = Math.random() * 50 + 15; // 15-65%
        this.safeZoneWidth = Math.random() * 15 + 20; // 20-35%

        const bonusOffset = Math.random() * (this.safeZoneWidth - 8);
        this.bonusZoneStart = this.safeZoneStart + bonusOffset;
        this.bonusZoneWidth = Math.min(8, this.safeZoneWidth - bonusOffset);

        if (this.skillCheckBar) {
          const safeZone = this.skillCheckBar.querySelector('.safe-zone');
          const bonusZone = this.skillCheckBar.querySelector('.bonus-zone');

          safeZone.style.left = this.safeZoneStart + '%';
          safeZone.style.width = this.safeZoneWidth + '%';

          bonusZone.style.left = this.bonusZoneStart + '%';
          bonusZone.style.width = this.bonusZoneWidth + '%';
        }
      }

      startSkillCheck() {
        if (this.isActive) return;

        this.isActive = true;
        this.skillCheckProgress = 0;
        this.skillCheckDirection = 1;

        this.generateRandomZones();
        this.skillCheckContainer.style.display = 'block';
        this.animateNeedle();
      }

      animateNeedle() {
        if (!this.isActive) return;

        this.skillCheckProgress += this.skillCheckSpeed * this.skillCheckDirection;

        if (this.skillCheckProgress >= 100) {
          this.skillCheckProgress = 100;
          this.skillCheckDirection = -1;
        } else if (this.skillCheckProgress <= 0) {
          this.skillCheckProgress = 0;
          this.skillCheckDirection = 1;
        }

        this.skillCheckNeedle.style.left = this.skillCheckProgress + '%';

        if (this.isActive) {
          requestAnimationFrame(() => this.animateNeedle());
        }
      }

      checkSkillCheck() {
        if (!this.isActive) return 'none';

        const needlePos = this.skillCheckProgress;
        const safeZoneEnd = this.safeZoneStart + this.safeZoneWidth;
        const bonusZoneEnd = this.bonusZoneStart + this.bonusZoneWidth;

        if (needlePos >= this.bonusZoneStart && needlePos <= bonusZoneEnd) {
          this.stopSkillCheck();
          return 'bonus';
        } else if (needlePos >= this.safeZoneStart && needlePos <= safeZoneEnd) {
          this.stopSkillCheck();
          return 'safe';
        } else {
          this.stopSkillCheck();
          return 'danger';
        }
      }

      stopSkillCheck() {
        this.isActive = false;
        this.skillCheckContainer.style.display = 'none';
      }
    }

    document.addEventListener('keydown', (event) => {
      if (event.code === 'Space' && skillCheckSystem && skillCheckSystem.isActive && isTransfusingActive) {
        event.preventDefault();

        const result = skillCheckSystem.checkSkillCheck();

        switch (result) {
          case 'bonus':
            updateTransfusionProgress(-10); // Progress cepat
            showSkillCheckFeedback('BONUS! +10', '#ffc107');
            break;

          case 'safe':
            updateTransfusionProgress(-8); // Progress normal
            showSkillCheckFeedback('Good!', '#4caf50');
            break;

          case 'danger':
            updateTransfusionProgress(+5); // Progress mundur
            showSkillCheckFeedback('Failed! -5', '#f44336');
            break;
        }
      }
    });

    // Popup Functions - Updated
    function showPopup() {
      const popup = document.getElementById('howToPlayPopup');
      if (popup) {
        popup.classList.remove('hidden');
        // Hide legend when popup is shown
        const legend = document.getElementById('tap-legend');
        if (legend) {
          legend.classList.add('hidden');
        }
      }
    }

    function closePopup() {
      const popup = document.getElementById('howToPlayPopup');
      if (popup) {
        popup.classList.add('hidden');
        // Show legend when popup is closed
        const legend = document.getElementById('tap-legend');
        if (legend) {
          legend.classList.remove('hidden');
        }
      }
    }

    function startGame() {
      closePopup();
      // Mulai tap game setelah popup ditutup
      tapGameState.active = true;
      console.log('Tap game started!');
    }

    // Auto-show popup only once when tap game starts
    let tapGamePopupShown = false;

    function showTapGameIntro() {
      if (!tapGamePopupShown) {
        setTimeout(() => {
          showPopup();
          tapGamePopupShown = true;
        }, 1000); // Show popup after 1 second
      }
    }

    function showBacteriaNotification() {
      const overlay = document.getElementById('bacteria-notification-overlay');
      const notification = document.getElementById('bacteria-notification');

      overlay.style.display = 'block';
      notification.style.display = 'block';
    }

    function closeBacteriaNotification() {
      const overlay = document.getElementById('bacteria-notification-overlay');
      const notification = document.getElementById('bacteria-notification');

      // Add slide out animation
      notification.classList.add('slide-out');
      overlay.classList.add('fade-out');

      setTimeout(() => {
        overlay.style.display = 'none';
        notification.style.display = 'none';
        notification.classList.remove('slide-out');
        overlay.classList.remove('fade-out');

        // Reset tap game after notification closes
        resetTapGameAfterBacteria();
      }, 300);
    }

    function resetTapGameAfterBacteria() {
      // Reset tap game state but don't lose all progress
      tapGameState.circles = []; // Clear all circles
      tapGameState.spawnTimer = 0; // Reset spawn timer

      // Optionally reduce progress as penalty
      tapGameState.progress = Math.max(0, tapGameState.progress - 10);
      updateTapUI();

      // Reactivate the game
      tapGameState.active = true;

      // Show helpful message
      setTimeout(() => {
        showAlert('Be more careful! Focus on collecting red blood cells only.', 'warning');
      }, 500);
    }
  </script>
  <!-- Tap Game Overlay -->
  <div id="tap-game-overlay">
    <div id="tap-game-container">
      <div id="tap-hud">
        Total : <span id="tap-score"> 0</span> ml
        <button class="help-btn-inline" onclick="showPopup()" title="How to Play">?</button>
      </div>
      <div id="tap-blood-bag-container"></div>
      <div id="tap-blood-fill"></div>
      <canvas id="tap-canvas" width="800" height="600"></canvas>

      <!-- Legend Container - Initially Hidden -->
      <div class="legend-container hidden" id="tap-legend">
        <div class="legend-item">
          <div class="legend-icon">
            <img src="img/darahMerah.png" alt="Blood Cell">
          </div>
          <span>Red Blood Cells - Click to collect</span>
        </div>
        <div class="legend-item">
          <div class="legend-icon">
            <img src="img/bakteri.png" alt="Bacteria">
          </div>
          <span>Bacteria - Avoid!</span>
        </div>
      </div>
    </div>
  </div>

  <!-- Fade Overlay -->
  <div class="fade-overlay" id="main-fade-overlay">
    <div id="fade-content">
      <div style="font-size: 32px; margin-bottom: 20px;">🩸</div>
      <div id="fade-text">Initiate the blood collection process...</div>
    </div>
  </div>
</body>

</html>